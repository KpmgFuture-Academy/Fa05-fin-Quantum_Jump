<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ë¥´ë‹¤ - ë§ˆì´í˜ì´ì§€</title>
    <style>
        /* index.htmlì˜ ì „ì²´ ìŠ¤íƒ€ì¼ì„ ê·¸ëŒ€ë¡œ ê°€ì ¸ì™€ ì¼ê´€ì„±ì„ ìœ ì§€í•©ë‹ˆë‹¤. */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; color: #333; }
        .layout { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: white; border-right: 1px solid #e9ecef; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        .logo-section { background: linear-gradient(135deg, #FF6B6B 0%, #FF5252 100%); color: white; padding: 1.5rem; text-align: center; }
        .logo { font-size: 1.8rem; font-weight: bold; margin-bottom: 0.5rem; }
        .logo-subtitle { font-size: 0.9rem; opacity: 0.9; }
        .nav-menu { padding: 1.5rem 0; }
        .nav-item { padding: 1rem 1.5rem; cursor: pointer; transition: all 0.3s ease; border-left: 4px solid transparent; display: flex; align-items: center; gap: 0.8rem; }
        .nav-item:hover { background-color: #f8f9fa; border-left-color: #FF6B6B; }
        .nav-item.active { background-color: #fff3f3; border-left-color: #FF6B6B; color: #FF6B6B; font-weight: 600; }
        .nav-icon { font-size: 1.1rem; width: 20px; }
        .main-content { flex: 1; padding: 2rem; overflow-y: auto; }
        .page-header { background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
        .page-title { font-size: 2.5rem; font-weight: 700; color: #2c3e50; margin-bottom: 1rem; }
        .page-subtitle { color: #6c757d; font-size: 1.1rem; line-height: 1.6; }
        .issues-section { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .section-title { font-size: 1.5rem; font-weight: 600; color: #2c3e50; display: flex; align-items: center; gap: 0.5rem; }
        
        /* --- â–¼â–¼â–¼ ì¹´ë“œ í¬ê¸° ë¬¸ì œ ìˆ˜ì •ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ ìˆ˜ì • â–¼â–¼â–¼ --- */
        .issues-grid { 
            display: grid; 
            /* auto-fit ëŒ€ì‹  auto-fillì„ ì‚¬ìš©í•˜ê³ , 1frë¡œ ëŠ˜ì–´ë‚˜ëŠ” ê²ƒì„ ì œí•œí•©ë‹ˆë‹¤. */
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        
        .issue-card { 
            /* ì¹´ë“œì˜ ìµœëŒ€ ë„ˆë¹„ë¥¼ ì§€ì •í•˜ì—¬ ê³¼ë„í•˜ê²Œ ëŠ˜ì–´ë‚˜ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤. */
            max-width: 450px;
            border: 2px solid #e9ecef; border-radius: 12px; padding: 1.5rem; cursor: pointer; 
            transition: all 0.3s ease; position: relative; background: white; overflow: hidden; 
        }

        .issue-card:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(0,0,0,0.15); border-color: #FF6B6B; }
        .issue-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        .issue-score { background: #f8f9fa; color: #6c757d; padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .issue-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.8rem; line-height: 1.4; color: #2c3e50; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .issue-content { color: #6c757d; font-size: 0.95rem; line-height: 1.6; margin-bottom: 1rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .issue-footer { display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; }
        .analyze-btn { background: linear-gradient(135deg, #FF6B6B 0%, #FF5252 100%); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
        .analyze-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4); }
        .unbookmark-btn { background: #6c757d; color: white; border: none; padding: 0.6rem 1rem; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .unbookmark-btn:hover { background: #5a6268; }
        
        .stats-section { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stats-title { font-size: 1.5rem; font-weight: 600; color: #2c3e50; margin-bottom: 2rem; text-align: left; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; text-align: center; }
        .stat-item { background: #f8f9fa; border-radius: 8px; padding: 1.5rem; }
        .stat-value { font-size: 2rem; font-weight: 700; color: #FF6B6B; margin-bottom: 0.5rem; }
        .stat-label { font-size: 0.9rem; color: #6c757d; }
        .modal-overlay { position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background: rgba(0, 0, 0, 0.7) !important; z-index: 9999 !important; display: none; justify-content: center; align-items: center; overflow-y: auto; }
        .modal-overlay.show { display: flex !important; }
        .modal-content { background: white; border-radius: 12px; max-width: 1000px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 2rem; position: relative; margin: 2rem; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); }
        .modal-close-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 24px; cursor: pointer; color: #666; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; }
        .modal-close-btn:hover { background: #f5f5f5; color: #333; }
        .modal-title { margin: 0 2rem 1.5rem 0; color: #2c3e50; font-size: 1.5rem; font-weight: 600; }
        .modal-score-section { margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .modal-content-section { margin-bottom: 2rem; }
        .modal-content-title { margin-bottom: 0.8rem; color: #333; font-size: 1.1rem; font-weight: 600; }
        .modal-content-box { background: #f9f9f9; padding: 1rem; border-radius: 8px; line-height: 1.6; color: #555; max-height: 200px; overflow-y: auto; }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
        .modal-section-title.industries { color: #FF6B6B; } .modal-section-title.past-issues { color: #667eea; } .modal-section-title.summary { color: #28a745; }
        .modal-highlight-box { padding: 1rem; border-radius: 8px; min-height: 200px; }
        .modal-highlight-box.industries { background: #fff3f3; border-left: 4px solid #FF6B6B; } .modal-highlight-box.past-issues { background: #f0f4ff; border-left: 4px solid #667eea; } .modal-highlight-box.summary { background: #f8fff9; border-left: 4px solid #28a745; }
        .modal-item { margin-bottom: 1rem; padding: 0.8rem; background: white; border-radius: 6px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .modal-item-title { font-weight: bold; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
        .modal-item-score { font-size: 0.9rem; color: #666; font-weight: normal; }
        .modal-item-reason { color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .modal-footer { border-top: 1px solid #eee; padding-top: 1rem; color: #666; font-size: 0.9rem; }
        .score-breakdown-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        .score-item { background: #f8f9fa; padding: 0.8rem; border-radius: 6px; border-left: 3px solid #2196F3; }
        .score-label { font-weight: 600; color: #333; font-size: 0.9rem; margin-bottom: 0.3rem; }
        .score-value-box { font-size: 1.1rem; font-weight: bold; color: #2196F3; margin-bottom: 0.5rem; }
        .score-reason { font-size: 0.8rem; color: #666; line-height: 1.4; font-weight: normal; }
        .verification-result { border-radius: 6px; margin: 0.5rem 0; transition: all 0.2s; }
        .simulation-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.8rem; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.3rem; font-weight: 600; }
        .simulation-btn:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
    </style>
</head>
<body>
    <div class="layout">
        <div class="sidebar">
            <div class="logo-section"><div class="logo">ì˜¤ë¥´ë‹¤</div><div class="logo-subtitle">íˆ¬ì í•™ìŠµ í”Œë«í¼</div></div>
            <div class="nav-menu">
                <div class="nav-item" onclick="navigateTo('home')"> <span class="nav-icon"></span> <span>Home</span> </div>
                <div class="nav-item active" onclick="navigateTo('mypage')"><span class="nav-icon"></span> <span>My Page</span> </div>
                <div class="nav-item" onclick="navigateTo('news')"> <span class="nav-icon"></span> <span>News</span> </div>
                <div class="nav-item" onclick="navigateTo('sector')"> <span class="nav-icon"></span> <span>Sector</span> </div>
                <div class="nav-item" onclick="navigateTo('company')"> <span class="nav-icon"></span> <span>Company</span> </div>
                <div class="nav-item" onclick="navigateTo('game')"> <span class="nav-icon"></span> <span>Game</span> </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="page-header"><h1 class="page-title">ë§ˆì´í˜ì´ì§€</h1><p class="page-subtitle">ì €ì¥í•œ ì´ìŠˆì™€ ë‚˜ì˜ ê²Œì„ ê¸°ë¡ì„ í™•ì¸í•´ë³´ì„¸ìš”.</p></div>
            <div class="issues-section">
                <div class="section-header"><h2 class="section-title">ì €ì¥í•œ ì´ìŠˆ</h2></div>
                <div class="issues-grid" id="bookmarked-issues-grid"></div>
            </div>
            <div class="stats-section">
                <h2 class="stats-title"> ë‚˜ì˜ ê²Œì„ í†µê³„</h2>
                <div class="stats-grid">
                    <div class="stat-item"><div class="stat-value" id="total-plays">0</div><div class="stat-label">ì´ í”Œë ˆì´ íšŸìˆ˜</div></div>
                    <div class="stat-item"><div class="stat-value" id="high-score">0</div><div class="stat-label">ìµœê³  ì ìˆ˜</div></div>
                    <div class="stat-item"><div class="stat-value" id="avg-accuracy">0%</div><div class="stat-label">í‰ê·  ì •ë‹µë¥ </div></div>
                    <div class="stat-item"><div class="stat-value" id="badges-earned"> 0</div><div class="stat-label">íšë“ ë±ƒì§€</div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="ai-analysis-modal" class="modal-overlay">
        <div class="modal-content">
            <button onclick="closeAIAnalysisModal()" class="modal-close-btn">&times;</button>
            <h2 id="modal-issue-title" class="modal-title"></h2>
            <div class="modal-score-section">
                <div> <strong> ì£¼ì‹ì‹œì¥ ê´€ë ¨ì„± ì ìˆ˜: <span id="score-value"></span>/10</strong> <button onclick="toggleScoreBreakdown()" style="margin-left: 10px; padding: 4px 8px; background: #e3f2fd; border: 1px solid #2196F3; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">ğŸ“‹ ì„¸ë¶€ì ìˆ˜</button> </div>
                <div> <span style="color:#666;"> RAG ë¶„ì„ ì‹ ë¢°ë„: <span id="rag-confidence"></span></span> </div>
            </div>
            <div id="score-breakdown-section" class="modal-content-section" style="display: none;">
                <h3 class="modal-content-title"> AI ì±„ì  ê·¼ê±° ë° ì„¸ë¶€ ì ìˆ˜</h3>
                <div id="score-breakdown-content" class="modal-content-box" style="max-height: 300px;">
                    <div class="score-breakdown-grid">
                        <div class="score-item"> <div class="score-label"> ì§ì ‘ì  ê¸°ì—…ì˜í–¥</div> <div class="score-value-box"> <span id="direct-company-score"></span>/10 <div id="direct-company-reason" class="score-reason"></div> </div> </div>
                        <div class="score-item"> <div class="score-label"> ì •ì±…ì  ì˜í–¥</div> <div class="score-value-box"> <span id="policy-score"></span>/10 <div id="policy-reason" class="score-reason"></div> </div> </div>
                        <div class="score-item"> <div class="score-label"> ì‹œì¥ ì‹¬ë¦¬</div> <div class="score-value-box"> <span id="market-sentiment-score"></span>/10 <div id="market-sentiment-reason" class="score-reason"></div> </div> </div>
                        <div class="score-item"> <div class="score-label"> ê±°ì‹œê²½ì œ</div> <div class="score-value-box"> <span id="macro-economic-score"></span>/10 <div id="macro-economic-reason" class="score-reason"></div> </div> </div>
                        <div class="score-item"> <div class="score-label"> ì‚°ì—… íŠ¸ë Œë“œ</div> <div class="score-value-box"> <span id="industry-trend-score"></span>/10 <div id="industry-trend-reason" class="score-reason"></div> </div> </div>
                        <div class="score-item"> <div class="score-label"> ì¢…í•© ê³„ì‚°</div> <div class="score-value-box"> <span id="total-calculation"></span> <div id="calculation-method" class="score-reason"></div> </div> </div>
                    </div>
                </div>
            </div>
            <div class="modal-content-section"> <h3 class="modal-content-title"> ì›ë³¸ ì´ìŠˆ ë‚´ìš©</h3> <div id="modal-issue-content" class="modal-content-box"></div> </div>
            <div class="modal-grid">
                <div class="modal-section"> <h3 class="modal-section-title industries"> ê´€ë ¨ ì‚°ì—… (RAG ë¶„ì„)</h3> <div id="modal-related-industries" class="modal-highlight-box industries"></div> </div>
                <div class="modal-section"> <h3 class="modal-section-title past-issues"> ê´€ë ¨ ê³¼ê±° ì´ìŠˆ (RAG ë¶„ì„)</h3> <div id="modal-related-past-issues" class="modal-highlight-box past-issues"></div> </div>
            </div>
            <div class="modal-section"> <h3 class="modal-section-title summary"> RAG ë¶„ì„ ìš”ì•½</h3> <div id="modal-rag-summary" class="modal-highlight-box summary"></div> </div>
            <div class="modal-footer"> <strong>ë¶„ì„ ì •ë³´:</strong> <span>ë²¡í„° ìœ ì‚¬ë„ ê²€ìƒ‰ + GPT-4o AI ë¶„ì„</span> | <span>Pinecone ë²¡í„°DB í™œìš©</span> | <span id="analysis-timestamp"></span> </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜: mypageì—ì„œëŠ” ì €ì¥ëœ ì´ìŠˆ ëª©ë¡ì´ í•µì‹¬ ë°ì´í„°ê°€ ë©ë‹ˆë‹¤.
        let currentIssues = []; 

        function navigateTo(page) {
            const pages = {
                home: '/static/index.html', news: '/static/news.html',
                sector: '/static/sector.html', company: '/static/company.html',
                game: '/static/game.html', mypage: '/static/mypage.html'

            };
            if (pages[page] && window.location.pathname !== pages[page]) {
                window.location.href = pages[page];
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            renderBookmarkedIssues();
            renderGameStats();
            setupModalEvents();
        });

        function renderBookmarkedIssues() {
            const grid = document.getElementById('bookmarked-issues-grid');
            currentIssues = JSON.parse(localStorage.getItem('bookmarkedIssues')) || [];

            if (currentIssues.length === 0) {
                grid.innerHTML = '<p style="text-align:center; color:#6c757d; padding: 2rem;">ì €ì¥í•œ ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤. í™ˆ í™”ë©´ì—ì„œ ê´€ì‹¬ìˆëŠ” ì´ìŠˆì˜ â˜†ë¥¼ ëˆŒëŸ¬ ì €ì¥í•´ë³´ì„¸ìš”!</p>';
                return;
            }

            grid.innerHTML = '';
            currentIssues.forEach((issue, index) => {
                const card = document.createElement('div');
                card.className = 'issue-card';
                
                const scoreText = normalizeStockRelevanceScore(issue.ì¢…í•©ì ìˆ˜);
                const score = parseFloat(scoreText);
                const scoreColor = score < 5 ? '#dc3545' : score < 7 ? '#ffc107' : '#28a745';

                card.innerHTML = `
                    <div class="issue-header">
                        <div class="issue-score" style="background: ${scoreColor}; color: white;">${scoreText}/10</div>
                    </div>
                    <div class="issue-title" onclick="showAIAnalysisModal(${index})">${issue.ì œëª© || 'ì œëª© ì—†ìŒ'}</div>
                    <div class="issue-content" onclick="showAIAnalysisModal(${index})">${(issue.ë‚´ìš© || '').substring(0, 150)}...</div>
                    <div class="issue-footer">
                        <button class="unbookmark-btn" onclick="unbookmarkIssue(${index})"> ì €ì¥ ì·¨ì†Œ</button>
                        <button class="analyze-btn" onclick="showAIAnalysisModal(${index})"> AI ë¶„ì„ ë³´ê¸°</button>
                    </div>`;
                grid.appendChild(card);
            });
        }

        function unbookmarkIssue(index) {
            event.stopPropagation();
            const issueToRemove = currentIssues[index];
            if (confirm(`'${issueToRemove.ì œëª©}' ì´ìŠˆë¥¼ ì €ì¥ ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                currentIssues.splice(index, 1);
                localStorage.setItem('bookmarkedIssues', JSON.stringify(currentIssues));
                renderBookmarkedIssues();
            }
        }

        function renderGameStats() {
            const stats = JSON.parse(localStorage.getItem('gameStats')) || { totalPlays: 0, highScore: 0, totalCorrect: 0, totalQuestions: 0, badges: 0 };
            const accuracy = (stats.totalQuestions > 0) ? ((stats.totalCorrect / stats.totalQuestions) * 100).toFixed(1) : 0;
            document.getElementById('total-plays').textContent = stats.totalPlays;
            document.getElementById('high-score').textContent = stats.highScore.toLocaleString();
            document.getElementById('avg-accuracy').textContent = `${accuracy}%`;
            document.getElementById('badges-earned').textContent = `ğŸ† ${stats.badges}`;
        }

        // --- â–¼â–¼â–¼ index.htmlì—ì„œ ê°€ì ¸ì˜¨ ëª¨ë‹¬ ë° ë¶„ì„ ê´€ë ¨ ëª¨ë“  í•¨ìˆ˜ â–¼â–¼â–¼ ---
        
        function setupModalEvents() {
            const modal = document.getElementById('ai-analysis-modal');
            modal.addEventListener('click', (e) => { if (e.target === modal) closeAIAnalysisModal(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.classList.contains('show')) closeAIAnalysisModal(); });
        }

        function normalizeStockRelevanceScore(score) {
            if (score === undefined || score === null) return 'N/A';
            const numScore = parseFloat(score);
            if (isNaN(numScore)) return 'N/A';
            if (numScore > 10) return Math.min(10, numScore / 5).toFixed(1);
            return Math.max(0, Math.min(10, numScore)).toFixed(1);
        }

        function showAIAnalysisModal(issueIndex) {
            const issue = currentIssues[issueIndex];
            if (!issue) return;

            const modal = document.getElementById('ai-analysis-modal');
            document.getElementById('modal-issue-title').textContent = issue.ì œëª©;
            document.getElementById('modal-issue-content').textContent = issue.ë‚´ìš©;
            document.getElementById('score-value').textContent = normalizeStockRelevanceScore(issue.ì¢…í•©ì ìˆ˜);
            
            const ragDetails = issue.RAGë¶„ì„ì‹ ë¢°ë„ || {};
            document.getElementById('rag-confidence').innerHTML = (ragDetails.consistency_score !== undefined) 
                ? `ì¼ê´€ì„±: ${ragDetails.consistency_score}/10, ìµœê³ ì—°ê´€ë„: ${ragDetails.peak_relevance_score}/10` 
                : 'N/A';
            
            setupEnhancedScoreBreakdown(issue);
            displayIndustriesWithFactCheck(issue);
            displayPastIssuesWithSimulation(issue);
            displayEnhancedRAGSummary(issue);
            
            document.getElementById('analysis-timestamp').textContent = `ë¶„ì„ ì‹œê°„: ${new Date(issue.ì¶”ì¶œì‹œê°„).toLocaleString('ko-KR')}`;
            modal.classList.add('show');
        }

        function setupEnhancedScoreBreakdown(issue) {
            const analysisData = issue.ê´€ë ¨ì„±_ë¶„ì„ || {};
            const scoreFields = { 'direct-company': 'ì§ì ‘ì _ê¸°ì—…ì˜í–¥', 'policy': 'ì •ì±…ì _ì˜í–¥', 'market-sentiment': 'ì‹œì¥_ì‹¬ë¦¬_ì˜í–¥', 'macro-economic': 'ê±°ì‹œê²½ì œ_ì˜í–¥', 'industry-trend': 'ì‚°ì—…_íŠ¸ë Œë“œ_ì˜í–¥' };
            let scores = {};
            for (const key in scoreFields) {
                const fieldName = scoreFields[key];
                const score = analysisData[fieldName];
                const reason = analysisData[fieldName + '_ê·¼ê±°'];
                document.getElementById(`${key}-score`).textContent = score !== undefined ? score : 'N/A';
                document.getElementById(`${key}-reason`).textContent = reason || getDefaultReason(fieldName, score);
                scores[fieldName] = score;
            }
            displayScoreCalculationMethod(issue, scores, analysisData);
        }

        function displayScoreCalculationMethod(issue, scores, analysisData) {
            const totalScore = issue.ì¢…í•©ì ìˆ˜;
            const validScores = Object.values(scores).filter(s => s !== 'N/A' && !isNaN(s)).map(s => parseFloat(s));
            const calcMethod = (analysisData && analysisData.ì¢…í•©ì ìˆ˜_ê³„ì‚°ë°©ì‹) || '';
            let calcText = '', methodText = '';

            if (validScores.length > 0) {
                const sum = validScores.reduce((a, b) => a + b, 0);
                if (calcMethod.toLowerCase() === 'í•©ê³„' || Math.abs(sum - totalScore) < 1) {
                    calcText = `${validScores.join(' + ')} = ${sum.toFixed(1)}ì `;
                    methodText = `5ê°œ í•­ëª© í•©ê³„ ë°©ì‹ (ì´ì : ${totalScore}ì /50ì )`;
                } else {
                    calcText = `AI ë…ì ê³„ì‚°: ${totalScore}ì `;
                    methodText = `AIê°€ ì¢…í•© ë¶„ì„í•˜ì—¬ ë…ìì ìœ¼ë¡œ ê³„ì‚°í•œ ì ìˆ˜`;
                }
                if (totalScore > 10) calcText += ` â†’ ${normalizeStockRelevanceScore(totalScore)}ì  (10ì  ë§Œì  ì •ê·œí™”)`;
            } else {
                calcText = `ì´ì : ${normalizeStockRelevanceScore(totalScore)}ì `;
                methodText = 'ì„¸ë¶€ ì ìˆ˜ ì •ë³´ê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
            }
            document.getElementById('total-calculation').textContent = calcText;
            document.getElementById('calculation-method').textContent = methodText;
        }

        function displayIndustriesWithFactCheck(issue) {
            const industriesDiv = document.getElementById('modal-related-industries');
            const relatedIndustries = (issue.ê´€ë ¨ì‚°ì—… || []).slice(0, 3);
            if (Array.isArray(relatedIndustries) && relatedIndustries.length > 0) {
                industriesDiv.innerHTML = relatedIndustries.map((industry, idx) => {
                    const verification = industry.verification || {};
                    const isVerified = verification.is_grounded === true;
                    const verificationIcon = isVerified ? 'âœ…' : 'âš ï¸';
                    const verificationText = isVerified ? 'íŒ©íŠ¸ì²´í‚¹ í†µê³¼' : 'ê·¼ê±° ë¶€ì¡±';
                    const verificationColor = isVerified ? '#28a745' : '#ffc107';
                    const supportingQuote = verification.supporting_quote || '';
                    const unverifiedReason = verification.unverified_reason || '';
                    return `<div class="modal-item" style="border-left: 4px solid ${verificationColor};"><div class="modal-item-title"><span>${idx + 1}. ${industry.name || 'ì‚°ì—…ëª… ì—†ìŒ'}</span><span class="modal-item-score">ìµœì¢…: ${industry.final_score || 'N/A'}/10</span></div><div class="verification-result" style="background: ${isVerified ? '#f8fff9' : '#fff8f0'}; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0;"><div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.3rem;"><span>${verificationIcon}</span><strong style="color: ${verificationColor};">${verificationText}</strong></div>${supportingQuote ? `<div style="font-style: italic; color: #666; font-size: 0.9rem;">"ë‰´ìŠ¤ ê·¼ê±°: ${supportingQuote}"</div>` : ''}${!isVerified && unverifiedReason ? `<div style="font-style: italic; color: #856404; font-size: 0.9rem;">(ì‚¬ìœ : ${unverifiedReason})</div>` : ''}</div><div class="modal-item-reason"><strong>AI ë¶„ì„ ê·¼ê±°:</strong> ${industry.ai_reason || 'ë¶„ì„ ì •ë³´ ì—†ìŒ'}</div></div>`;
                }).join('');
            } else { industriesDiv.innerHTML = '<div style="color:#666; text-align:center; padding:2rem;">ê´€ë ¨ ì‚°ì—… ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; }
        }

        function displayPastIssuesWithSimulation(issue) {
            const pastIssuesDiv = document.getElementById('modal-related-past-issues');
            pastIssuesDiv.innerHTML = '<div style="color:#666; text-align:center; padding:2rem;">ê³¼ê±° ì´ìŠˆ ì‹œë®¬ë ˆì´ì…˜ì€ í™ˆì—ì„œë§Œ ì œê³µë©ë‹ˆë‹¤.</div>';
        }

        function displayEnhancedRAGSummary(issue) {
            const summaryDiv = document.getElementById('modal-rag-summary');
            const industries = issue.ê´€ë ¨ì‚°ì—… || [];
            const pastIssues = issue.ê´€ë ¨ê³¼ê±°ì´ìŠˆ || [];
            const iVerified = industries.filter(i => i.verification?.is_grounded).length;
            const pVerified = pastIssues.filter(p => p.verification?.is_grounded).length;
            const totalVerified = iVerified + pVerified;
            const totalItems = Math.min(industries.length, 3) + Math.min(pastIssues.length, 3);
            const rag = issue.RAGë¶„ì„ì‹ ë¢°ë„ || {};
            const consistency = rag.consistency_score || 0;
            const peak = rag.peak_relevance_score || 0;
            const trustInfo = getTrustLevelInfo(totalVerified, totalItems, consistency, peak);
            summaryDiv.innerHTML = `<div style="line-height:1.6;"><h4 style="margin-bottom:1rem;color:#333;">ğŸ” RAG ë¶„ì„ ìš”ì•½</h4><div style="background:#f8f9fa;padding:1rem;border-radius:6px;margin-bottom:1rem;"><div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;"><div><strong>ğŸ“Š ì‹ ë¢°ë„ ì§€í‘œ</strong><br>â€¢ ì¼ê´€ì„±: ${consistency}/10<br>â€¢ ìµœê³ ì—°ê´€ë„: ${peak}/10</div><div><strong>âœ… íŒ©íŠ¸ì²´í‚¹</strong><br>â€¢ ê²€ì¦ í†µê³¼: ${totalVerified}/${totalItems||'N/A'} ê°œ<br>â€¢ ì„±ê³µë¥ : ${totalItems>0?Math.round(totalVerified/totalItems*100):0}%</div></div></div><div style="margin-bottom:1rem;"><strong>ğŸ­ ì‚°ì—… ë¶„ì„:</strong> ${industries.length > 0 ? `${industries.length}ê°œ ë°œê²¬, ${iVerified}ê°œ íŒ©íŠ¸ì²´í‚¹ í†µê³¼` : 'ì •ë³´ ì—†ìŒ'}</div><div style="margin-bottom:1rem;"><strong>ğŸ“š ê³¼ê±° ì´ìŠˆ:</strong> ${pastIssues.length > 0 ? `${pastIssues.length}ê°œ ë°œê²¬, ${pVerified}ê°œ íŒ©íŠ¸ì²´í‚¹ í†µê³¼` : 'ì •ë³´ ì—†ìŒ'}</div><div style="background:${trustInfo.color.bg};padding:0.8rem;border-radius:6px;border-left:4px solid ${trustInfo.color.border};"><strong>ğŸ’¡ ì¢…í•© íŒë‹¨:</strong> ${trustInfo.message}</div></div>`;
        }

        function getTrustLevelInfo(verified, total, consistency, peak) {
            const verificationRate = total > 0 ? verified / total : 0;
            const avgScore = (consistency + peak) / 2;
            if (verificationRate >= 0.8 && avgScore >= 7) return { message: "ë§¤ìš° ë†’ì€ ì‹ ë¢°ë„ì˜ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.", color: { bg: '#e8f5e8', border: '#28a745' } };
            if (verificationRate >= 0.5 && avgScore >= 5) return { message: "ì–‘í˜¸í•œ ìˆ˜ì¤€ì˜ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤. ì¶”ê°€ ì •ë³´ì™€ í•¨ê»˜ ì°¸ê³ í•˜ì„¸ìš”.", color: { bg: '#fff3cd', border: '#ffc107' } };
            return { message: "ë‚®ì€ ì‹ ë¢°ë„ì˜ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤. ì°¸ê³ ìš©ìœ¼ë¡œë§Œ í™œìš©í•˜ì„¸ìš”.", color: { bg: '#f8d7da', border: '#dc3545' } };
        }

        function getDefaultReason(category, score) {
            if (score === 'N/A' || isNaN(score)) return 'ë¶„ì„ ê·¼ê±°ê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
            const s = parseFloat(score);
            const r = { 'ì§ì ‘ì _ê¸°ì—…ì˜í–¥': { h: 'ì‹¤ì /ì£¼ê°€ì— ì§ì ‘ì  ì˜í–¥ ë¶„ì„', m: 'ì¼ë¶€ ê¸°ì—…ì— ê°„ì ‘ì  ì˜í–¥ ì˜ˆìƒ', l: 'ì§ì ‘ì  ì˜í–¥ ë¯¸ë¯¸' }, 'ì •ì±…ì _ì˜í–¥': { h: 'ì •ë¶€ ì •ì±…/ê·œì œ ë³€í™”ê°€ ì‹œì¥ì— í° ì˜í–¥ ì „ë§', m: 'ì •ì±…ì  ìš”ì†Œ ìˆìœ¼ë‚˜ ì˜í–¥ ë²”ìœ„ ì œí•œì ', l: 'ì •ì±…ê³¼ ê´€ë ¨ì„± ë‚®ìŒ' }, 'ì‹œì¥_ì‹¬ë¦¬_ì˜í–¥': { h: 'íˆ¬ìì ì‹¬ë¦¬ì— ìƒë‹¹í•œ ì˜í–¥ ì˜ˆìƒ', m: 'ì¼ë¶€ íˆ¬ìì ê´€ì‹¬ ìœ ë°œ ìˆ˜ì¤€', l: 'ì‹¬ë¦¬ ì˜í–¥ ì œí•œì ' }, 'ê±°ì‹œê²½ì œ_ì˜í–¥': { h: 'ê±°ì‹œê²½ì œ ì§€í‘œì— ì˜í–¥ ê°€ëŠ¥ì„±', m: 'ê±°ì‹œê²½ì œì— ì¼ë¶€ ì˜í–¥', l: 'ê±°ì‹œê²½ì œ ì˜í–¥ ë¯¸ë¯¸' }, 'ì‚°ì—…_íŠ¸ë Œë“œ_ì˜í–¥': { h: 'ì‚°ì—… íŠ¸ë Œë“œë¥¼ í¬ê²Œ ë³€í™”ì‹œí‚¬ ì´ìŠˆ', m: 'íŠ¹ì • ì‚°ì—… íŠ¸ë Œë“œì— ì¼ë¶€ ì˜í–¥', l: 'ì‚°ì—… íŠ¸ë Œë“œ ì˜í–¥ ì œí•œì ' } };
            const catR = r[category] || r['ì§ì ‘ì _ê¸°ì—…ì˜í–¥'];
            if (s >= 7) return catR.h; if (s >= 4) return catR.m; return catR.l;
        }
        
        function toggleScoreBreakdown() {
            const section = document.getElementById('score-breakdown-section');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        function closeAIAnalysisModal() { 
            document.getElementById('ai-analysis-modal').classList.remove('show'); 
        }
    </script>
</body>
</html>