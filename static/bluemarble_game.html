<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>금융 마스터 블루마블 (v2.2 - Final Fix)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Pretendard', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .game-header { text-align: center; color: white; margin-bottom: 20px; animation: fadeInDown 0.8s ease; }
        .game-title { font-size: 2.5rem; font-weight: bold; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .players-info { display: flex; gap: 20px; margin-bottom: 20px; animation: fadeIn 0.8s ease 0.2s both; }
        .player-card { background: white; border-radius: 15px; padding: 15px 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 15px; min-width: 220px; transition: all 0.3s ease; }
        .player-card.active { border: 3px solid #ffc107; transform: scale(1.05); box-shadow: 0 8px 25px rgba(255, 193, 7, 0.4); }
        .player-avatar { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .player1-avatar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .player2-avatar { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .player-info { flex: 1; }
        .player-name { font-weight: bold; color: #333; margin-bottom: 5px; }
        .player-stats { display: flex; gap: 15px; font-size: 0.9rem; }
        .stat { color: #666; }
        .stat-value { font-weight: bold; color: #333; }
        .game-container { background: #2c3e50; border-radius: 20px; padding: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); animation: fadeIn 0.8s ease 0.4s both; }
        .game-board { display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); gap: 2px; background: #34495e; padding: 10px; border-radius: 15px; width: 880px; height: 880px; position: relative; }
        .board-center { grid-column: 2 / 11; grid-row: 2 / 11; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .center-logo { font-size: 3rem; margin-bottom: 10px; }
        .center-title { font-size: 1.8rem; font-weight: bold; color: #2e7d32; margin-bottom: 20px; }
        .dice-area { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .dice-container { perspective: 1000px; display: flex; gap: 25px; }
        .dice { width: 70px; height: 70px; position: relative; transform-style: preserve-3d; transition: transform 1s cubic-bezier(.6,-0.28,.74,1.29); }
        .dice-face { position: absolute; width: 100%; height: 100%; background: #fff; border: 2px solid #555; border-radius: 10px; display: grid; padding: 6px; }
        .pip { width: 14px; height: 14px; background-color: #333; border-radius: 50%; align-self: center; justify-self: center; }
        .face-1 { grid-template-areas: ". . ." ". a ." ". . ."; } .face-2 { grid-template-areas: "a . ." ". . ." ". . b"; } .face-3 { grid-template-areas: "a . ." ". b ." ". . c"; } .face-4 { grid-template-areas: "a . b" ". . ." "c . d"; } .face-5 { grid-template-areas: "a . b" ". c ." "d . e"; } .face-6 { grid-template-areas: "a . b" "c . d" "e . f"; }
        .face-1 .pip:nth-child(1) { grid-area: a; } .face-2 .pip:nth-child(1) { grid-area: a; } .face-2 .pip:nth-child(2) { grid-area: b; } .face-3 .pip:nth-child(1) { grid-area: a; } .face-3 .pip:nth-child(2) { grid-area: b; } .face-3 .pip:nth-child(3) { grid-area: c; } .face-4 .pip:nth-child(1) { grid-area: a; } .face-4 .pip:nth-child(2) { grid-area: b; } .face-4 .pip:nth-child(3) { grid-area: c; } .face-4 .pip:nth-child(4) { grid-area: d; } .face-5 .pip:nth-child(1) { grid-area: a; } .face-5 .pip:nth-child(2) { grid-area: b; } .face-5 .pip:nth-child(3) { grid-area: c; } .face-5 .pip:nth-child(4) { grid-area: d; } .face-5 .pip:nth-child(5) { grid-area: e; } .face-6 .pip:nth-child(1) { grid-area: a; } .face-6 .pip:nth-child(2) { grid-area: b; } .face-6 .pip:nth-child(3) { grid-area: c; } .face-6 .pip:nth-child(4) { grid-area: d; } .face-6 .pip:nth-child(5) { grid-area: e; } .face-6 .pip:nth-child(6) { grid-area: f; }
        .face-1 { transform: rotateY(0deg) translateZ(35px); } .face-6 { transform: rotateY(180deg) translateZ(35px); } .face-2 { transform: rotateY(-90deg) translateZ(35px); } .face-5 { transform: rotateY(90deg) translateZ(35px); } .face-3 { transform: rotateX(90deg) translateZ(35px); } .face-4 { transform: rotateX(-90deg) translateZ(35px); }
        .roll-button { padding: 12px 30px; background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white; border: none; border-radius: 25px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3); }
        .roll-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4); }
        .roll-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .board-tile { background: white; border: 1px solid #bdc3c7; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 5px; cursor: pointer; transition: all 0.3s ease; overflow: hidden; }
        .board-tile:hover { transform: scale(1.05); z-index: 10; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        .tile-corner { grid-column: span 1; grid-row: span 1; width: 80px; height: 80px; }
        .tile-color-band { position: absolute; top: 0; left: 0; right: 0; height: 20px; display: flex; align-items: center; justify-content: center; }
        .tile-name { font-size: 0.65rem; font-weight: bold; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .tile-content { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 2px; margin-top: 20px; }
        .tile-corner .tile-content { margin-top: 0; }
        .tile-price { font-size: 0.7rem; font-weight: bold; color: #2c3e50; }
        .tile-icon { font-size: 1.2rem; margin: 2px 0; }
        .building-container { position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); display: flex; gap: 2px; }
        .building { width: 12px; height: 15px; border: 1px solid rgba(0,0,0,0.4); border-radius: 2px 2px 0 0; box-shadow: 0 2px 4px rgba(0,0,0,0.2); animation: buildingAppear 0.3s ease; }
        .building-player1 { background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%); }
        .building-player2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        @keyframes buildingAppear { from { transform: scale(0) translateY(10px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
        .player-piece { position: absolute; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: all 0.1s linear; z-index: 20; box-shadow: 0 2px 8px rgba(0,0,0,0.3); border: 2px solid white; }
        .piece-info { position: absolute; top: 105%; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.7); color: white; padding: 2px 6px; border-radius: 5px; font-size: 0.6rem; white-space: nowrap; display: flex; gap: 4px; align-items: center; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .player-piece.active .piece-info { opacity: 1; }
        .player1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); top: 45%; left: 30%; }
        .player2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); top: 45%; left: 55%; }
        .tile-start { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); } .tile-jail { background: linear-gradient(135deg, #535353 0%, #2c3e50 100%); color: white; } .tile-parking { background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); } .tile-travel { background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%); }
        .band-red { background: linear-gradient(135deg, #e74c3c, #c0392b); } .band-orange { background: linear-gradient(135deg, #e67e22, #d35400); } .band-yellow { background: linear-gradient(135deg, #f1c40f, #f39c12); } .band-green { background: linear-gradient(135deg, #27ae60, #229954); } .band-blue { background: linear-gradient(135deg, #3498db, #2980b9); } .band-purple { background: linear-gradient(135deg, #9b59b6, #8e44ad); } .band-pink { background: linear-gradient(135deg, #e91e63, #c2185b); } .band-teal { background: linear-gradient(135deg, #1abc9c, #16a085); }
        .quiz-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .quiz-modal.show { display: flex; animation: fadeIn 0.3s ease; }
        .quiz-content { background: white; border-radius: 25px; padding: 40px; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s ease; }
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .quiz-title { font-size: 1.6rem; color: #333; }
        .quiz-tile-info { padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: bold; color: white; }
        .quiz-question { background: #f8f9fa; padding: 25px; border-radius: 15px; margin-bottom: 25px; }
        .quiz-term { font-size: 1.8rem; font-weight: bold; color: #667eea; margin-bottom: 15px; text-align: center; }
        .quiz-description { color: #666; line-height: 1.6; text-align: center; }
        .quiz-options { display: grid; gap: 12px; margin-bottom: 25px; }
        .quiz-option { padding: 15px 20px; background: white; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 10px; }
        .quiz-option:hover:not(.selected):not(.correct):not(.incorrect) { border-color: #667eea; background: #f8f9ff; transform: translateX(5px); }
        .quiz-option.selected { border-color: #667eea; background: #f0f4ff; }
        .quiz-option.correct { border-color: #10b981 !important; background: #d1fae5 !important; animation: correctPulse 0.5s ease; }
        .quiz-option.incorrect { border-color: #ef4444 !important; background: #fee2e2 !important; animation: shake 0.5s ease; }
        .option-letter { width: 30px; height: 30px; background: #f3f4f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #667eea; }
        .quiz-actions { display: flex; gap: 15px; justify-content: center; }
        .quiz-button { padding: 12px 30px; border: none; border-radius: 20px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .submit-answer { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .submit-answer:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3); }
        .submit-answer:disabled { opacity: 0.6; cursor: not-allowed; }
        @keyframes correctPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 960px) { .game-board { width: 660px; height: 660px; } .board-tile { font-size: 0.8rem; } .tile-corner { width: 60px; height: 60px; } }
    </style>
</head>
<body>
    <div class="game-header"><h1 class="game-title"> 금융 마스터 블루마블</h1></div>
    <div class="players-info">
        <div class="player-card active" id="player-card-1">
            <div class="player-avatar player1-avatar"></div>
            <div class="player-info">
                <div class="player-name">Player 1</div>
                <div class="player-stats">
                    <span class="stat"> <span class="stat-money">200만원</span></span>
                    <span class="stat"> <span class="stat-building">0개</span></span>
                </div>
            </div>
        </div>
        <div class="player-card" id="player-card-2">
            <div class="player-avatar player2-avatar"></div>
            <div class="player-info">
                <div class="player-name">Player 2</div>
                <div class="player-stats">
                    <span class="stat"> <span class="stat-money">200만원</span></span>
                    <span class="stat"> <span class="stat-building">0개</span></span>
                </div>
            </div>
        </div>
    </div>
    <div class="game-container">
        <div class="game-board" id="gameBoard">
            <div class="board-center">
                <div class="center-logo"></div>
                <div class="center-title">금융 마스터</div>
                <div class="dice-area">
                    <div class="dice-container">
                        <div class="dice" id="dice1">
                            <div class="dice-face face-1"><span class="pip"></span></div><div class="dice-face face-2"><span class="pip"></span><span class="pip"></span></div><div class="dice-face face-3"><span class="pip"></span><span class="pip"></span><span class="pip"></span></div><div class="dice-face face-4"><span class="pip"></span><span class="pip"></span><span class="pip"></span><span class="pip"></span></div><div class="dice-face face-5"><span class="pip"></span><span class="pip"></span><span class="pip"></span><span class="pip"></span><span class="pip"></span></div><div class="dice-face face-6"><span class="pip"></span><span class="pip"></span><span class="pip"></span><span class="pip"></span><span class="pip"></span><span class="pip"></span></div>
                        </div>
                        <div class="dice" id="dice2">
                            <div class="dice-face face-1"><span class="pip"></span></div><div class="dice-face face-2"><span class="pip"></span><span class="pip"></span></div><div class="dice-face face-3"><span class="pip"></span><span class="pip"></span><span class="pip"></span></div><div class="dice-face face-4"><span class="pip"></span><span class="pip"></span><span class="pip"></span><span class="pip"></span></div><div class="dice-face face-5"><span class="pip"></span><span class="pip"></span><span class="pip"></span><span class="pip"></span><span class="pip"></span></div><div class="dice-face face-6"><span class="pip"></span><span class="pip"></span><span class="pip"></span><span class="pip"></span><span class="pip"></span><span class="pip"></span></div>
                        </div>
                    </div>
                    <button class="roll-button" onclick="rollDice()"> 주사위 굴리기</button>
                </div>
            </div>
        </div>
    </div>
    <div class="quiz-modal" id="quizModal">
        <div class="quiz-content">
            <div class="quiz-header">
                <h2 class="quiz-title" id="quiz-title"></h2>
                <div class="quiz-tile-info"></div>
            </div>
            <div class="quiz-question"><div class="quiz-term"></div><div class="quiz-description"></div></div>
            <div class="quiz-options"></div>
            <div class="quiz-actions"><button class="quiz-button submit-answer">정답 확인</button></div>
        </div>
    </div>

<script>
    const boardData = [ { type: 'start', name: 'START', icon: '' }, { type: 'property', name: '주식', price: 10, color: 'red' }, { type: 'property', name: '채권', price: 10, color: 'red' }, { type: 'property', name: '펀드', price: 12, color: 'red' }, { type: 'bonus', name: '보너스', icon: '' }, { type: 'property', name: 'ETF', price: 14, color: 'orange' }, { type: 'property', name: '선물', price: 14, color: 'orange' }, { type: 'chance', name: '찬스', icon: '' }, { type: 'property', name: '옵션', price: 16, color: 'orange' }, { type: 'property', name: 'PER', price: 18, color: 'yellow' }, { type: 'jail', name: '감옥', icon: '' }, { type: 'property', name: 'PBR', price: 18, color: 'yellow' }, { type: 'property', name: 'ROE', price: 20, color: 'yellow' }, { type: 'bonus', name: '보너스', icon: '' }, { type: 'property', name: 'EPS', price: 22, color: 'green' }, { type: 'property', name: 'BPS', price: 22, color: 'green' }, { type: 'chance', name: '찬스', icon: '' }, { type: 'property', name: '배당률', price: 24, color: 'green' }, { type: 'property', name: '시가총액', price: 26, color: 'blue' }, { type: 'property', name: '거래량', price: 26, color: 'blue' }, { type: 'parking', name: '무료주차', icon: '🅿️' }, { type: 'property', name: '매수/매도', price: 28, color: 'blue' }, { type: 'bonus', name: '보너스', icon: '' }, { type: 'property', name: 'IPO', price: 30, color: 'purple' }, { type: 'property', name: '공모주', price: 30, color: 'purple' }, { type: 'chance', name: '찬스', icon: '' }, { type: 'property', name: '증자', price: 32, color: 'purple' }, { type: 'property', name: '코스피', price: 35, color: 'pink' }, { type: 'bonus', name: '보너스', icon: '' }, { type: 'property', name: '코스닥', price: 35, color: 'pink' }, { type: 'travel', name: '세계여행', icon: '✈️' }, { type: 'property', name: '나스닥', price: 40, color: 'pink' }, { type: 'chance', name: '찬스', icon: '' }, { type: 'property', name: 'S&P500', price: 45, color: 'teal' }, { type: 'property', name: '다우존스', price: 45, color: 'teal' }, { type: 'bonus', name: '보너스', icon: '' }, { type: 'property', name: '닛케이', price: 50, color: 'teal' }, { type: 'chance', name: '찬스', icon: '' }, { type: 'property', name: '환율', price: 55, color: 'red' }, { type: 'property', name: '금리', price: 60, color: 'red' }, ];
    const quizData = [ { term: 'PER', description: 'Price Earnings Ratio의 약자로, 주가를 주당순이익(EPS)으로 나눈 값입니다. 기업이 벌어들이는 이익에 비해 주가가 높은지 낮은지를 판단하는 지표는?', options: ['주가수익비율', '주가순자산비율', '자기자본이익률', '부채비율'], correctIndex: 0 }, { term: 'PBR', description: 'Price Book-value Ratio의 약자로, 주가를 주당순자산가치(BPS)로 나눈 값입니다. 기업의 자산가치 대비 주가 수준을 나타내는 지표는?', options: ['주가순자산비율', '주가수익비율', '총자산순이익률', '배당수익률'], correctIndex: 0 }, { term: 'IPO', description: 'Initial Public Offering의 약자로, 비상장기업이 처음으로 주식을 공개적으로 판매하여 증권거래소에 상장하는 절차를 무엇이라고 할까요?', options: ['기업공개', '유상증자', '무상증자', '자사주 매입'], correctIndex: 0 }, { term: 'ETF', description: 'Exchange Traded Fund의 약자로, 특정 주가 지수나 자산의 움직임에 따라 수익률이 결정되는, 거래소에 상장되어 주식처럼 거래되는 펀드를 무엇이라 할까요?', options: ['상장지수펀드', '인덱스 펀드', '뮤추얼 펀드', '헤지 펀드'], correctIndex: 0 } ];

    let gameState = {
        currentPlayer: 1,
        players: {
            1: { position: 0, money: 2000000, buildings: [], element: null },
            2: { position: 0, money: 2000000, buildings: [], element: null }
        },
        isRolling: false,
        currentQuizTile: null,
        currentQuiz: null,
        currentAction: null
    };

    document.addEventListener('DOMContentLoaded', () => {
        createBoard();
        gameState.players[1].element = document.getElementById('player-piece-1');
        gameState.players[2].element = document.getElementById('player-piece-2');
        updatePlayerInfo();
    });

    function getTilePosition(index) {
        if (index >= 0 && index <= 10) return { r: 11, c: 11 - index };
        if (index >= 11 && index <= 20) return { r: 11 - (index - 10), c: 1 };
        if (index >= 21 && index <= 30) return { r: 1, c: 1 + (index - 20) };
        if (index >= 31 && index <= 39) return { r: 1 + (index - 30), c: 11 };
        return {};
    }

    function createBoard() {
        const boardEl = document.getElementById('gameBoard');
        boardData.forEach((data, index) => {
            const pos = getTilePosition(index);
            const tile = document.createElement('div');
            tile.className = 'board-tile';
            tile.style.gridRow = pos.r;
            tile.style.gridColumn = pos.c;
            tile.dataset.index = index;
            tile.dataset.type = data.type;
            
            let contentHTML = '';
            if (data.type === 'property') {
                tile.dataset.owner = 'none';
                contentHTML = `<div class="tile-color-band band-${data.color}"><span class="tile-name">${data.name}</span></div><div class="tile-content"><div class="tile-price">${data.price}만원</div></div><div class="building-container"></div>`;
            } else {
                tile.classList.add(`tile-${data.type}`);
                const isCorner = ['start', 'jail', 'parking', 'travel'].includes(data.type);
                if(isCorner) tile.classList.add('tile-corner');
                contentHTML = `<div class="tile-content"><div class="tile-icon">${data.icon}</div><div style="font-size: ${isCorner ? '0.8rem' : '0.7rem'}; font-weight: bold; color: ${data.type === 'jail' ? 'white' : 'inherit'};">${data.name}</div></div>`;
            }
            tile.innerHTML = contentHTML;
            boardEl.appendChild(tile);
        });
        
        const startTile = boardEl.querySelector('[data-type="start"]');
        startTile.innerHTML += `<div class="player-piece player1 active" id="player-piece-1"><div class="piece-info"></div></div><div class="player-piece player2" id="player-piece-2"><div class="piece-info"></div></div>`;
        boardEl.appendChild(boardEl.querySelector('.board-center'));
    }

    function rollDice() {
        if (gameState.isRolling) return;
        gameState.isRolling = true;
        document.querySelector('.roll-button').disabled = true;
        
        const dice1 = document.getElementById('dice1');
        const dice2 = document.getElementById('dice2');
        const value1 = Math.floor(Math.random() * 6) + 1;
        const value2 = Math.floor(Math.random() * 6) + 1;
        
        const rotations = { 1: { x: 0, y: 0 }, 2: { x: 0, y: -90 }, 3: { x: 90, y: 0 }, 4: { x: -90, y: 0 }, 5: { x: 0, y: 90 }, 6: { x: 0, y: 180 } };

        dice1.style.transform = `rotateX(${Math.random()*2160+1080}deg) rotateY(${Math.random()*2160+1080}deg)`;
        dice2.style.transform = `rotateX(${Math.random()*2160+1080}deg) rotateY(${Math.random()*2160+1080}deg)`;

        setTimeout(() => {
            dice1.style.transform = `rotateX(${rotations[value1].x}deg) rotateY(${rotations[value1].y}deg)`;
            dice2.style.transform = `rotateX(${rotations[value2].x}deg) rotateY(${rotations[value2].y}deg)`;
            setTimeout(() => movePlayer(gameState.currentPlayer, value1 + value2), 1200);
        }, 1000);
    }

    async function movePlayer(playerNum, steps) {
        const player = gameState.players[playerNum];
        for (let i = 0; i < steps; i++) {
            const oldPos = player.position;
            player.position = (player.position + 1) % 40;
            const newTile = document.querySelector(`.board-tile[data-index='${player.position}']`);
            if (newTile) newTile.appendChild(player.element);
            if (player.position < oldPos) {
                player.money += 2000000;
                showMessage('START 지점 통과! 200만원 획득!');
                updatePlayerInfo();
            }
            await new Promise(resolve => setTimeout(resolve, 120));
        }
        handleTileEffect(playerNum, document.querySelector(`.board-tile[data-index='${player.position}']`));
    }
    
    // --- BUG FIX: 턴 관리 로직을 명확하게 수정한 함수 ---
    function handleTileEffect(playerNum, tile) {
        const type = tile.dataset.type;
        const player = gameState.players[playerNum];

        // 1. Property 타일 처리 (퀴즈 필요)
        if (type === 'property') {
            const owner = tile.dataset.owner;
            if (owner === 'none') {
                gameState.currentAction = 'build';
            } else if (owner !== playerNum.toString()) {
                gameState.currentAction = 'payToll';
            } else { // 자기 땅
                showMessage(`자신의 땅 '${boardData[tile.dataset.index].name}'에 도착했습니다.`);
                endTurn();
                return;
            }
            showQuizModal(tile);
            return; // 퀴즈를 보여준 후에는 턴을 넘기지 않음
        }

        // 2. 특수 타일 처리 (퀴즈 불필요)
        let needsImmediateEndTurn = true;
        switch (type) {
            case 'bonus':
                player.money += 1000000;
                showMessage('보너스! 100만원 획득!');
                break;
            case 'chance':
                const chances = [ { text: '배당금 수령! 50만원 획득', money: 500000 }, { text: '세금 납부! 100만원 차감', money: -1000000 }, { text: '투자 수익! 150만원 획득', money: 1500000 }, { text: '수수료 지불! 50만원 차감', money: -500000 } ];
                const chance = chances[Math.floor(Math.random() * chances.length)];
                player.money += chance.money;
                showMessage(chance.text);
                break;
            case 'jail':
                showMessage('감옥! 한 턴 쉽니다.');
                break;
            case 'parking':
            case 'start':
                showMessage('휴식 중...');
                break;
            case 'travel':
                showMessage('세계 여행! START로 이동합니다.');
                needsImmediateEndTurn = false; // 이동 후에 턴이 결정되므로 지금 넘기지 않음
                const stepsToStart = (40 - player.position) % 40;
                setTimeout(() => movePlayer(playerNum, stepsToStart), 500);
                break;
        }

        updatePlayerInfo();
        if (needsImmediateEndTurn) {
            endTurn();
        }
    }
    
    document.querySelector('.submit-answer').addEventListener('click', function() {
        const selected = document.querySelector('.quiz-option.selected');
        if (!selected) return alert('답을 선택해주세요!');

        const playerNum = gameState.currentPlayer;
        const player = gameState.players[playerNum];
        const tile = gameState.currentQuizTile;
        const tileData = boardData[tile.dataset.index];
        const isCorrect = parseInt(selected.dataset.index) === gameState.currentQuiz.correctIndex;

        selected.classList.add(isCorrect ? 'correct' : 'incorrect');
        if (!isCorrect) {
            document.querySelector(`.quiz-option[data-index='${gameState.currentQuiz.correctIndex}']`).classList.add('correct');
        }
        this.disabled = true;

        setTimeout(() => {
            if (gameState.currentAction === 'build') {
                if (isCorrect) {
                    showMessage('정답! 무료로 건물을 건설합니다!');
                    buildBuilding(playerNum, tile);
                } else {
                    showMessage('오답! 아쉽지만 다음 기회에...');
                }
            } else if (gameState.currentAction === 'payToll') {
                const ownerNum = tile.dataset.owner;
                const owner = gameState.players[ownerNum];
                const toll = tileData.price * 10000;
                player.money -= toll;
                owner.money += toll;
                let message = `정답! 통행료 ${toll.toLocaleString()}원 지불 완료!`;
                if (!isCorrect) {
                    const penalty = 500000;
                    player.money -= penalty;
                    message = `오답! 통행료 ${toll.toLocaleString()}원에 벌금 50만원 추가 지불!`;
                }
                showMessage(message);
                updatePlayerInfo(); // 돈이 변경되었으므로 즉시 업데이트
                if (player.money < 0) {
                    endGame(ownerNum);
                    return; 
                }
            }
            closeQuizModal();
            endTurn();
        }, 1500);
    });

    function showQuizModal(tile) {
        const modal = document.getElementById('quizModal');
        const randomQuiz = quizData[Math.floor(Math.random() * quizData.length)];
        gameState.currentQuiz = randomQuiz;
        gameState.currentQuizTile = tile;

        const tileData = boardData[tile.dataset.index];
        document.getElementById('quiz-title').textContent = tile.dataset.owner === 'none' ? ' 건물 찬스 퀴즈' : ' 통행료 감면 퀴즈';
        document.querySelector('.quiz-tile-info').textContent = tileData.name;
        document.querySelector('.quiz-tile-info').className = `quiz-tile-info band-${tileData.color}`;
        document.querySelector('.quiz-term').textContent = randomQuiz.term;
        document.querySelector('.quiz-description').textContent = randomQuiz.description;
        
        const optionsContainer = document.querySelector('.quiz-options');
        optionsContainer.innerHTML = '';
        randomQuiz.options.forEach((text, index) => {
            const opt = document.createElement('div');
            opt.className = 'quiz-option';
            opt.dataset.index = index;
            opt.innerHTML = `<span class="option-letter">${String.fromCharCode(65 + index)}</span><span>${text}</span>`;
            opt.addEventListener('click', function() {
                if (document.querySelector('.quiz-option.correct, .quiz-option.incorrect')) return;
                document.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
            });
            optionsContainer.appendChild(opt);
        });
        modal.classList.add('show');
    }

    function closeQuizModal() {
        document.getElementById('quizModal').classList.remove('show');
        const submitBtn = document.querySelector('.submit-answer');
        if (submitBtn) {
            submitBtn.disabled = false;
        }
    }

    function buildBuilding(playerNum, tile) {
        const container = tile.querySelector('.building-container');
        const building = document.createElement('div');
        building.className = `building building-player${playerNum}`;
        container.appendChild(building);
        tile.dataset.owner = playerNum;
        gameState.players[playerNum].buildings.push(tile.dataset.index);
    }
    
    // BUG FIX: 모든 정보 업데이트를 담당하는 단일 함수. 안정성을 위해 명시적으로 작성
    function updatePlayerInfo() {
        for (const playerNum of [1, 2]) {
            const player = gameState.players[playerNum];
            const card = document.getElementById(`player-card-${playerNum}`);
            const piece = document.getElementById(`player-piece-${playerNum}`);
            
            // 방어 코드: 엘리먼트가 없으면 에러를 발생시키지 않고 건너뜀
            if (!card || !piece) continue; 
            const pieceInfo = piece.querySelector('.piece-info');
            if (!pieceInfo) continue;

            card.classList.toggle('active', playerNum == gameState.currentPlayer);
            piece.classList.toggle('active', playerNum == gameState.currentPlayer);
            
            // 카드 정보 업데이트
            card.querySelector('.stat-money:first-of-type').textContent = `${(player.money / 10000).toLocaleString()}만원`;
            card.querySelector('.stat-building:last-of-type').textContent = `${player.buildings.length}개`;
            
            // 플레이어 말 하단 정보 업데이트
            pieceInfo.innerHTML = `${(player.money / 10000).toLocaleString()} | ${player.buildings.length}`;
        }
    }

    function endGame(winnerNum) {
        gameState.isRolling = true;
        document.querySelector('.roll-button').disabled = true;
        setTimeout(() => {
            alert(`Player ${winnerNum}의 승리! 게임을 종료합니다.`);
            location.reload();
        }, 500);
    }
    
    function endTurn() {
        gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
        updatePlayerInfo();
        setTimeout(() => {
            gameState.isRolling = false;
            document.querySelector('.roll-button').disabled = false;
        }, 500);
    }

    function showMessage(text) {
        const msg = document.createElement('div');
        msg.style.cssText = `position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.85); color: white; padding: 20px 40px; border-radius: 15px; font-size: 1.2rem; font-weight: bold; z-index: 2000; animation: fadeIn 0.3s ease-out;`;
        msg.textContent = text;
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 2800);
    }

    document.addEventListener('keydown', e => {
        if (e.code === 'Space' && !gameState.isRolling && !document.querySelector('.quiz-modal.show')) {
            e.preventDefault();
            rollDice();
        }
    });
</script>
</body>
</html>