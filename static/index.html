<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ë¥´ë‹¤ - ì˜¤ëŠ˜ì˜ ì´ìŠˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; color: #333; }
        .layout { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: white; border-right: 1px solid #e9ecef; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        .logo-section { background: linear-gradient(135deg, #FF6B6B 0%, #FF5252 100%); color: white; padding: 1.5rem; text-align: center; }
        .logo { font-size: 1.8rem; font-weight: bold; margin-bottom: 0.5rem; }
        .logo-subtitle { font-size: 0.9rem; opacity: 0.9; }
        .nav-menu { padding: 1.5rem 0; }
        .nav-item { padding: 1rem 1.5rem; cursor: pointer; transition: all 0.3s ease; border-left: 4px solid transparent; display: flex; align-items: center; gap: 0.8rem; }
        .nav-item:hover { background-color: #f8f9fa; border-left-color: #FF6B6B; }
        .nav-item.active { background-color: #fff3f3; border-left-color: #FF6B6B; color: #FF6B6B; font-weight: 600; }
        .nav-icon { font-size: 1.1rem; width: 20px; }
        .main-content { flex: 1; padding: 2rem; overflow-y: auto; }
        .page-header { background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); text-align: center; }
        .welcome-text { color: #6c757d; font-size: 1.1rem; margin-bottom: 0.5rem; }
        .page-title { font-size: 2.5rem; font-weight: 700; color: #2c3e50; margin-bottom: 1rem; }
        .page-subtitle { color: #6c757d; font-size: 1.1rem; line-height: 1.6; }
        .today-date { background: linear-gradient(135deg, #FF6B6B 0%, #FF5252 100%); color: white; padding: 0.8rem 1.5rem; border-radius: 25px; display: inline-block; margin-top: 1rem; font-weight: 600; }
        .issues-section { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .section-title { font-size: 1.5rem; font-weight: 600; color: #2c3e50; display: flex; align-items: center; gap: 0.5rem; }
        .issues-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; }
        .issue-card { border: 2px solid #e9ecef; border-radius: 12px; padding: 1.5rem; cursor: pointer; transition: all 0.3s ease; position: relative; background: white; overflow: hidden; }
        .issue-card:hover { transform: translateY(-4px); box-shadow: 0 12px 30px rgba(0,0,0,0.15); border-color: #FF6B6B; }
        .issue-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #FF6B6B, #667eea, #a8e6cf); opacity: 0; transition: opacity 0.3s ease; }
        .issue-card:hover::before { opacity: 1; }
        .issue-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        .issue-number { background: #f8f9fa; color: #6c757d; padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .issue-rank { background: linear-gradient(135deg, #FF6B6B, #667eea); color: white; padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .issue-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.8rem; line-height: 1.4; color: #2c3e50; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .issue-content { color: #6c757d; font-size: 0.95rem; line-height: 1.6; margin-bottom: 1rem; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .issue-footer { display: flex; justify-content: flex-end; align-items: center; gap: 0.5rem; }
        .analyze-btn { background: linear-gradient(135deg, #FF6B6B 0%, #FF5252 100%); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
        .analyze-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4); }
        .bookmark-btn { background: #ffc107; color: #333; border: none; padding: 0.6rem 1rem; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .bookmark-btn:hover { background: #ffb300; transform: translateY(-1px); }
        .loading { text-align: center; padding: 3rem; color: #6c757d; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #FF6B6B; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-bar { background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-radius: 8px; padding: 1rem 1.5rem; margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; }
        .status-info { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;}
        .status-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: #495057; }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; background: #28a745; }
        .modal-overlay { position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background: rgba(0, 0, 0, 0.7) !important; z-index: 9999 !important; display: none; justify-content: center; align-items: center; overflow-y: auto; }
        .modal-overlay.show { display: flex !important; }
        .modal-content { background: white; border-radius: 12px; max-width: 1000px; width: 95%; max-height: 90vh; overflow-y: auto; padding: 2rem; position: relative; margin: 2rem; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); }
        .modal-close-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 24px; cursor: pointer; color: #666; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; }
        .modal-close-btn:hover { background: #f5f5f5; color: #333; }
        .modal-title { margin: 0 2rem 1.5rem 0; color: #2c3e50; font-size: 1.5rem; font-weight: 600; }
        .modal-score-section { margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .modal-content-section { margin-bottom: 2rem; }
        .modal-content-title { margin-bottom: 0.8rem; color: #333; font-size: 1.1rem; font-weight: 600; }
        .modal-content-box { background: #f9f9f9; padding: 1rem; border-radius: 8px; line-height: 1.6; color: #555; max-height: 200px; overflow-y: auto; }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem; }
        .modal-section-title.industries { color: #FF6B6B; }
        .modal-section-title.past-issues { color: #667eea; }
        .modal-section-title.summary { color: #28a745; }
        .modal-highlight-box { padding: 1rem; border-radius: 8px; min-height: 200px; }
        .modal-highlight-box.industries { background: #fff3f3; border-left: 4px solid #FF6B6B; }
        .modal-highlight-box.past-issues { background: #f0f4ff; border-left: 4px solid #667eea; }
        .modal-highlight-box.summary { background: #f8fff9; border-left: 4px solid #28a745; }
        .modal-item { margin-bottom: 1rem; padding: 0.8rem; background: white; border-radius: 6px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); }
        .modal-item-title { font-weight: bold; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
        .modal-item-score { font-size: 0.9rem; color: #666; font-weight: normal; }
        .modal-item-reason { color: #666; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .modal-item-meta { color: #999; font-size: 0.8rem; }
        .modal-footer { border-top: 1px solid #eee; padding-top: 1rem; color: #666; font-size: 0.9rem; }
        .score-breakdown-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        .score-item { background: #f8f9fa; padding: 0.8rem; border-radius: 6px; border-left: 3px solid #2196F3; }
        .score-label { font-weight: 600; color: #333; font-size: 0.9rem; margin-bottom: 0.3rem; }
        .score-value-box { font-size: 1.1rem; font-weight: bold; color: #2196F3; margin-bottom: 0.5rem; }
        .score-reason { font-size: 0.8rem; color: #666; line-height: 1.4; font-weight: normal; }
        .verification-result { border-radius: 6px; margin: 0.5rem 0; transition: all 0.2s; }
        .simulation-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.8rem; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.3rem; font-weight: 600; }
        .simulation-btn:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .issue-bookmark {
            font-size: 1.8rem; /* ë³„ ì•„ì´ì½˜ í¬ê¸° */
            color: #ced4da; /* ê¸°ë³¸ ë¹ˆ ë³„ ìƒ‰ìƒ */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .issue-bookmark:hover {
            transform: scale(1.2); /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ì‚´ì§ ì»¤ì§€ê²Œ */
        }

        .issue-bookmark.bookmarked {
            color: #FFC107; /* ë¶ë§ˆí¬ëœ ë³„ ìƒ‰ìƒ (ë…¸ë€ìƒ‰) */
        }
        @media (max-width: 1024px) { .issues-grid { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); } .modal-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .layout { flex-direction: column; } .sidebar { width: 100%; order: 2; } .main-content { order: 1; padding: 1rem; } .issues-grid { grid-template-columns: 1fr; } .page-title { font-size: 2rem; } .modal-content { margin: 1rem; padding: 1.5rem; } .modal-grid { grid-template-columns: 1fr; gap: 1rem; } }
    </style>
</head>
<body>
    <!-- (ê¸°ì¡´ sidebar, main-content ë“± HTML êµ¬ì¡°ëŠ” ë™ì¼) -->
    <div class="layout">
        <div class="sidebar">
            <div class="logo-section">
                <div class="logo">ì˜¤ë¥´ë‹¤</div>
                <div class="logo-subtitle">íˆ¬ì í•™ìŠµ í”Œë«í¼</div>
            </div>
            <div class="nav-menu">
                <div class="nav-item active" onclick="navigateTo('home')"> <span class="nav-icon"></span> <span>Home</span> </div>
                <div class="nav-item" onclick="navigateTo('mypage')"> <span class="nav-icon"></span> <span>My Page</span> </div>
                <div class="nav-item" onclick="navigateTo('news')"> <span class="nav-icon"></span> <span>News</span> </div>
                <div class="nav-item" onclick="navigateTo('sector')"> <span class="nav-icon"></span> <span>Sector</span> </div>
                <div class="nav-item" onclick="navigateTo('company')"> <span class="nav-icon"></span> <span>Company</span> </div>
                <div class="nav-item" onclick="navigateTo('game')"> <span class="nav-icon"></span> <span>Game</span> </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="page-header">
                <div class="welcome-text">íˆ¬ì í•™ìŠµì˜ ì‹œì‘</div>
                <h1 class="page-title">ì˜¤ëŠ˜ì˜ ì´ìŠˆ</h1>
                <p class="page-subtitle"> AIê°€ ì„ ë³„í•œ ì£¼ì‹ì‹œì¥ ê´€ë ¨ í•µì‹¬ ì´ìŠˆë“¤ì„<br> ë¶„ì„í•˜ì—¬ íˆ¬ì ì¸ì‚¬ì´íŠ¸ë¥¼ ì–»ì–´ë³´ì„¸ìš” </p>
                <div class="today-date" id="today-date"></div>
            </div>
            
            <div class="status-bar">
                <div class="status-info">
                    <div class="status-item"> <div class="status-indicator"></div> <span>AI í•„í„°ë§ í™œì„±í™”</span> </div>
                    <div class="status-item"> <span> ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="last-update-time"></span></span> </div>
                    <div class="status-item"> <span> AI ì„ ë³„ <span id="issue-count">0</span>ê°œ ì´ìŠˆ</span> </div>
                </div>
                <button id="refresh-issues-btn" style="padding: 0.5rem 1rem; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;">  ìƒˆë¡œê³ ì¹¨ </button>
            </div>
            
            <div class="issues-section">
                <div class="section-header">
                    <h2 class="section-title">  AI ì„ ë³„ ì£¼ìš” ì´ìŠˆ (<span id="grid-issue-count">0</span>ê°œ) </h2>
                </div>
                <div class="issues-grid" id="issues-grid">
                    <div class="loading" id="loading-state">
                        <div class="spinner"></div> <p>AIê°€ ì„ ë³„í•œ ì´ìŠˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="ai-analysis-modal" class="modal-overlay">
        <div class="modal-content">
            <button onclick="closeAIAnalysisModal()" class="modal-close-btn">&times;</button>
            <h2 id="modal-issue-title" class="modal-title"></h2>
            <div class="modal-score-section">
                <div> <strong> ì£¼ì‹ì‹œì¥ ê´€ë ¨ì„± ì ìˆ˜: <span id="score-value"></span>/10</strong> <button onclick="toggleScoreBreakdown()" style="margin-left: 10px; padding: 4px 8px; background: #e3f2fd; border: 1px solid #2196F3; border-radius: 4px; cursor: pointer; font-size: 0.8rem;"> ì„¸ë¶€ì ìˆ˜</button> </div>
                <div> <span style="color:#666;"> RAG ë¶„ì„ ì‹ ë¢°ë„: <span id="rag-confidence"></span></span> </div>
            </div>
            <div id="score-breakdown-section" class="modal-content-section" style="display: none;">
                <h3 class="modal-content-title"> AI ì±„ì  ê·¼ê±° ë° ì„¸ë¶€ ì ìˆ˜</h3>
                <div id="score-breakdown-content" class="modal-content-box" style="max-height: 300px;">
                    <div class="score-breakdown-grid">
                        <div class="score-item"> <div class="score-label"> ì§ì ‘ì  ê¸°ì—…ì˜í–¥</div> <div class="score-value-box"> <span id="direct-company-score"></span>/10 <div id="direct-company-reason" class="score-reason"></div> </div> </div>
                        <div class="score-item"> <div class="score-label">ğŸ›ï¸ ì •ì±…ì  ì˜í–¥</div> <div class="score-value-box"> <span id="policy-score"></span>/10 <div id="policy-reason" class="score-reason"></div> </div> </div>
                        <div class="score-item"> <div class="score-label"> ì‹œì¥ ì‹¬ë¦¬</div> <div class="score-value-box"> <span id="market-sentiment-score"></span>/10 <div id="market-sentiment-reason" class="score-reason"></div> </div> </div>
                        <div class="score-item"> <div class="score-label"> ê±°ì‹œê²½ì œ</div> <div class="score-value-box"> <span id="macro-economic-score"></span>/10 <div id="macro-economic-reason" class="score-reason"></div> </div> </div>
                        <div class="score-item"> <div class="score-label"> ì‚°ì—… íŠ¸ë Œë“œ</div> <div class="score-value-box"> <span id="industry-trend-score"></span>/10 <div id="industry-trend-reason" class="score-reason"></div> </div> </div>
                        <div class="score-item"> <div class="score-label"> ì¢…í•© ê³„ì‚°</div> <div class="score-value-box"> <span id="total-calculation"></span> <div id="calculation-method" class="score-reason"></div> </div> </div>
                    </div>
                </div>
            </div>
            <div class="modal-content-section"> <h3 class="modal-content-title"> ì›ë³¸ ì´ìŠˆ ë‚´ìš©</h3> <div id="modal-issue-content" class="modal-content-box"></div> </div>
            <div class="modal-grid">
                <div class="modal-section"> <h3 class="modal-section-title industries"> ê´€ë ¨ ì‚°ì—… (RAG ë¶„ì„)</h3> <div id="modal-related-industries" class="modal-highlight-box industries"></div> </div>
                <div class="modal-section"> <h3 class="modal-section-title past-issues"> ê´€ë ¨ ê³¼ê±° ì´ìŠˆ (RAG ë¶„ì„)</h3> <div id="modal-related-past-issues" class="modal-highlight-box past-issues"></div> </div>
            </div>
            <div class="modal-section"> <h3 class="modal-section-title summary"> RAG ë¶„ì„ ìš”ì•½</h3> <div id="modal-rag-summary" class="modal-highlight-box summary"></div> </div>
            <div class="modal-footer"> <strong>ë¶„ì„ ì •ë³´:</strong> <span>ë²¡í„° ìœ ì‚¬ë„ ê²€ìƒ‰ + GPT-4o AI ë¶„ì„</span> | <span>Pinecone ë²¡í„°DB í™œìš©</span> | <span id="analysis-timestamp"></span> </div>
        </div>
    </div>

    <script>
        // --- ê¸°ì¡´ index.html ìŠ¤í¬ë¦½íŠ¸ (ìˆ˜ì • ì—†ìŒ) ---
        let currentIssues = [];
        let isRefreshing = false;

        document.addEventListener('DOMContentLoaded', function() {
            updateTodayDate();
            loadCurrentIssues();
            setupRefreshButton();
            setupModalEvents();
        });

        function setupModalEvents() {
            const modal = document.getElementById('ai-analysis-modal');
            modal.addEventListener('click', (e) => { if (e.target === modal) closeAIAnalysisModal(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.classList.contains('show')) closeAIAnalysisModal(); });
        }

        function updateTodayDate() {
            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('today-date').textContent = today.toLocaleDateString('ko-KR', options);
            document.getElementById('last-update-time').textContent = today.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        }

        function normalizeStockRelevanceScore(score) {
            if (score === undefined || score === null) return 'N/A';
            const numScore = parseFloat(score);
            if (numScore > 10) return Math.min(10, numScore / 5).toFixed(1);
            return Math.max(0, Math.min(10, numScore)).toFixed(1);
        }

        async function loadCurrentIssues() {
            if (isRefreshing) return;
            isRefreshing = true;
            const loadingEl = document.getElementById('loading-state');
            loadingEl.style.display = 'block';
            loadingEl.innerHTML = `<div style="text-align: center; padding: 2rem;"><div class="spinner"></div><p> AIê°€ ì„ ë³„í•œ ì´ìŠˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>`;

            try {
                const response = await fetch('/api/news/latest');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const result = await response.json();
                console.log(' API ì‘ë‹µ ë°ì´í„°:', result);

                let issuesData = [];
                if (result && Array.isArray(result.selected_issues)) {
                    issuesData = result.selected_issues;
                } else if (result && result.data && Array.isArray(result.data.issues)) {
                    issuesData = result.data.issues;
                } else if (result && result.data && Array.isArray(result.data.selected_issues)) {
                    issuesData = result.data.selected_issues;
                }

                if (issuesData.length === 0) {
                    throw new Error('API ì‘ë‹µì—ì„œ ì´ìŠˆ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                currentIssues = issuesData.map((issue, index) => ({
                    ...issue,
                    ì¢…í•©ì ìˆ˜: issue.ì£¼ì‹ì‹œì¥_ê´€ë ¨ì„±_ì ìˆ˜ !== undefined ? issue.ì£¼ì‹ì‹œì¥_ê´€ë ¨ì„±_ì ìˆ˜ : (issue.ì¢…í•©ì ìˆ˜ || 0),
                    ranking: issue.rank || index + 1
                }));
                
                displayIssues(currentIssues);
                updateIssueCounts(currentIssues.length);
                showNotification(` AIê°€ ì„ ë³„í•œ ${currentIssues.length}ê°œ í•µì‹¬ ì´ìŠˆë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!`, 'success');

            } catch (error) {
                console.error(' API í˜¸ì¶œ ë˜ëŠ” ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                loadingEl.innerHTML = `<div style="text-align: center; padding: 2rem;"><p style="color: #dc3545; margin-bottom: 1rem;">âš ï¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p><button onclick="loadCurrentIssues()" style="background: #FF6B6B; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; cursor: pointer;"> ë‹¤ì‹œ ì‹œë„</button></div>`;
                showNotification(' ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
            } finally {
                isRefreshing = false;
                loadingEl.style.display = 'none';
            }
        }

        function updateIssueCounts(count) {
            document.querySelectorAll('#issue-count, #grid-issue-count').forEach(el => el.textContent = count);
        }

        function displayIssues(issues) {
            const grid = document.getElementById('issues-grid');
            if (!grid) return;
            grid.innerHTML = '';

            // mypage.htmlì—ì„œ ì‚¬ìš©í•  ë¶ë§ˆí¬ ì •ë³´ë¥¼ localStorageì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const bookmarkedIssues = JSON.parse(localStorage.getItem('bookmarkedIssues')) || [];

            issues.forEach((issue, index) => {
                const card = document.createElement('div');
                card.className = 'issue-card';
                
                const score = parseFloat(normalizeStockRelevanceScore(issue.ì¢…í•©ì ìˆ˜));
                const scoreColor = score < 5 ? '#dc3545' : score < 7 ? '#ffc107' : '#28a745';

                // ë¶ë§ˆí¬ ì—¬ë¶€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤. (ì—¬ê¸°ì„œëŠ” ì œëª©ì„ ê³ ìœ  IDì²˜ëŸ¼ ì‚¬ìš©)
                const isBookmarked = bookmarkedIssues.some(b => b.ì œëª© === issue.ì œëª©);

                // --- â–¼â–¼â–¼ ì—¬ê¸°ê°€ ìš”ì²­ëŒ€ë¡œ ìˆ˜ì •ëœ ë¶€ë¶„ì…ë‹ˆë‹¤ â–¼â–¼â–¼ ---
                card.innerHTML = `
                    <div class="issue-header">
                        <div class="issue-number" style="background: ${scoreColor}; color: white;">${score.toFixed(1)}/10</div>
                        
                        <div class="issue-bookmark ${isBookmarked ? 'bookmarked' : ''}" onclick="bookmarkIssue(this, ${index})">
                            ${isBookmarked ? 'â˜…' : 'â˜†'}
                        </div>
                    </div>
                    <div class="issue-title">${issue.ì œëª© || 'ì œëª© ì—†ìŒ'}</div>
                    <div class="issue-content">${(issue.ë‚´ìš© || '').substring(0, 150)}...</div>
                    <div class="issue-footer"> 
                        <button class="analyze-btn" onclick="showAIAnalysisModal(${index})">AI ë¶„ì„ ë³´ê¸°</button>
                    </div>`;

                grid.appendChild(card);
            });
        }
        
        function bookmarkIssue(element, issueIndex) {
            // ì´ë²¤íŠ¸ ë²„ë¸”ë§ì„ ë§‰ì•„, ë³„ì„ ëˆŒë €ì„ ë•Œ ì¹´ë“œ ì „ì²´ê°€ ëˆŒë¦¬ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
            event.stopPropagation(); 

            const issueToBookmark = currentIssues[issueIndex];
            let bookmarkedIssues = JSON.parse(localStorage.getItem('bookmarkedIssues')) || [];

            // ì´ë¯¸ ë¶ë§ˆí¬ëœ ì´ìŠˆì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.
            const existingIndex = bookmarkedIssues.findIndex(b => b.ì œëª© === issueToBookmark.ì œëª©);

            if (existingIndex > -1) {
                // ì´ë¯¸ ë¶ë§ˆí¬ ë˜ì–´ìˆë‹¤ë©´ -> ë¶ë§ˆí¬ í•´ì œ
                bookmarkedIssues.splice(existingIndex, 1); // ë°°ì—´ì—ì„œ ì œê±°
                element.innerHTML = 'â˜†'; // ë¹ˆ ë³„ë¡œ ë³€ê²½
                element.classList.remove('bookmarked');
                showNotification(`'${issueToBookmark.ì œëª©}' ë¶ë§ˆí¬ë¥¼ í•´ì œí–ˆìŠµë‹ˆë‹¤.`, 'info');
            } else {
                // ë¶ë§ˆí¬ ë˜ì–´ìˆì§€ ì•Šë‹¤ë©´ -> ë¶ë§ˆí¬ ì¶”ê°€
                bookmarkedIssues.push(issueToBookmark); // ë°°ì—´ì— ì¶”ê°€
                element.innerHTML = 'â˜…'; // ì±„ì›Œì§„ ë³„ë¡œ ë³€ê²½
                element.classList.add('bookmarked');
                showNotification(`'${issueToBookmark.ì œëª©}' ì´ìŠˆë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤!`, 'success');
            }

            // ë³€ê²½ëœ ë¶ë§ˆí¬ ëª©ë¡ì„ localStorageì— ë‹¤ì‹œ ì €ì¥í•©ë‹ˆë‹¤.
            localStorage.setItem('bookmarkedIssues', JSON.stringify(bookmarkedIssues));
        }

        function showAIAnalysisModal(issueIndex) {
            const issue = currentIssues[issueIndex];
            if (!issue) return;

            const modal = document.getElementById('ai-analysis-modal');
            document.getElementById('modal-issue-title').textContent = issue.ì œëª©;
            document.getElementById('modal-issue-content').textContent = issue.ë‚´ìš©;
            document.getElementById('score-value').textContent = normalizeStockRelevanceScore(issue.ì¢…í•©ì ìˆ˜);
            
            const ragDetails = issue.RAGë¶„ì„ì‹ ë¢°ë„ || {};
            document.getElementById('rag-confidence').innerHTML = (ragDetails.consistency_score !== undefined) 
                ? `ì¼ê´€ì„±: ${ragDetails.consistency_score}/10, ìµœê³ ì—°ê´€ë„: ${ragDetails.peak_relevance_score}/10` 
                : 'N/A';
            
            setupEnhancedScoreBreakdown(issue);
            displayIndustriesWithFactCheck(issue);
            displayPastIssuesWithSimulation(issue);
            displayEnhancedRAGSummary(issue);
            
            document.getElementById('analysis-timestamp').textContent = `ë¶„ì„ ì‹œê°„: ${new Date(issue.ì¶”ì¶œì‹œê°„).toLocaleString('ko-KR')}`;
            modal.classList.add('show');
        }

        function setupEnhancedScoreBreakdown(issue) {
            const analysisData = issue.ê´€ë ¨ì„±_ë¶„ì„ || {};
            const scoreFields = {
                'direct-company': 'ì§ì ‘ì _ê¸°ì—…ì˜í–¥', 'policy': 'ì •ì±…ì _ì˜í–¥',
                'market-sentiment': 'ì‹œì¥_ì‹¬ë¦¬_ì˜í–¥', 'macro-economic': 'ê±°ì‹œê²½ì œ_ì˜í–¥',
                'industry-trend': 'ì‚°ì—…_íŠ¸ë Œë“œ_ì˜í–¥'
            };
            let scores = {};
            for (const key in scoreFields) {
                const fieldName = scoreFields[key];
                const score = analysisData[fieldName];
                const reason = analysisData[fieldName + '_ê·¼ê±°'];
                document.getElementById(`${key}-score`).textContent = score !== undefined ? score : 'N/A';
                document.getElementById(`${key}-reason`).textContent = reason || getDefaultReason(fieldName, score);
                scores[fieldName] = score;
            }
            displayScoreCalculationMethod(issue, scores, analysisData);
        }

        function displayScoreCalculationMethod(issue, scores, analysisData) {
            const totalScore = issue.ì¢…í•©ì ìˆ˜;
            const validScores = Object.values(scores).filter(s => s !== 'N/A' && !isNaN(s)).map(s => parseFloat(s));
            const calcMethod = (analysisData && analysisData.ì¢…í•©ì ìˆ˜_ê³„ì‚°ë°©ì‹) || '';
            let calcText = '', methodText = '';

            if (validScores.length > 0) {
                const sum = validScores.reduce((a, b) => a + b, 0);
                if (calcMethod.toLowerCase() === 'í•©ê³„' || Math.abs(sum - totalScore) < 1) {
                    calcText = `${validScores.join(' + ')} = ${sum.toFixed(1)}ì `;
                    methodText = `5ê°œ í•­ëª© í•©ê³„ ë°©ì‹ (ì´ì : ${totalScore}ì /50ì )`;
                } else {
                    calcText = `AI ë…ì ê³„ì‚°: ${totalScore}ì `;
                    methodText = `AIê°€ ì¢…í•© ë¶„ì„í•˜ì—¬ ë…ìì ìœ¼ë¡œ ê³„ì‚°í•œ ì ìˆ˜`;
                }
                if (totalScore > 10) calcText += ` â†’ ${normalizeStockRelevanceScore(totalScore)}ì  (10ì  ë§Œì  ì •ê·œí™”)`;
            } else {
                calcText = `ì´ì : ${totalScore}ì `;
                methodText = 'ì„¸ë¶€ ì ìˆ˜ ì •ë³´ê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
            }
            document.getElementById('total-calculation').textContent = calcText;
            document.getElementById('calculation-method').textContent = methodText;
        }

        function displayIndustriesWithFactCheck(issue) {
            const industriesDiv = document.getElementById('modal-related-industries');
            const relatedIndustries = (issue.ê´€ë ¨ì‚°ì—… || []).slice(0, 3);
            
            if (Array.isArray(relatedIndustries) && relatedIndustries.length > 0) {
                industriesDiv.innerHTML = relatedIndustries.map((industry, idx) => {
                    const verification = industry.verification || {};
                    const isVerified = verification.is_grounded === true;
                    const verificationIcon = isVerified ? '' : 'âš ï¸';
                    const verificationText = isVerified ? 'íŒ©íŠ¸ì²´í‚¹ í†µê³¼' : 'ê·¼ê±° ë¶€ì¡±';
                    const verificationColor = isVerified ? '#28a745' : '#ffc107';
                    const supportingQuote = verification.supporting_quote || '';
                    const unverifiedReason = verification.unverified_reason || '';

                    return `
                        <div class="modal-item" style="border-left: 4px solid ${verificationColor};">
                            <div class="modal-item-title">
                                <span>${idx + 1}. ${industry.name || 'ì‚°ì—…ëª… ì—†ìŒ'}</span>
                                <span class="modal-item-score">ìµœì¢…: ${industry.final_score || 'N/A'}/10</span>
                            </div>
                            <div class="verification-result" style="background: ${isVerified ? '#f8fff9' : '#fff8f0'}; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.3rem;">
                                    <span>${verificationIcon}</span><strong style="color: ${verificationColor};">${verificationText}</strong>
                                </div>
                                ${supportingQuote ? `<div style="font-style: italic; color: #666; font-size: 0.9rem;">"ë‰´ìŠ¤ ê·¼ê±°: ${supportingQuote}"</div>` : ''}
                                ${!isVerified && unverifiedReason ? `<div style="font-style: italic; color: #856404; font-size: 0.9rem;">(ì‚¬ìœ : ${unverifiedReason})</div>` : ''}
                            </div>
                            <div class="modal-item-reason"><strong>AI ë¶„ì„ ê·¼ê±°:</strong> ${industry.ai_reason || 'ë¶„ì„ ì •ë³´ ì—†ìŒ'}</div>
                        </div>`;
                }).join('');
            } else { industriesDiv.innerHTML = '<div style="color:#666; text-align:center; padding:2rem;">ê´€ë ¨ ì‚°ì—… ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; }
        }

        function displayEnhancedRAGSummary(issue) {
            const summaryDiv = document.getElementById('modal-rag-summary');
            const industries = issue.ê´€ë ¨ì‚°ì—… || [];
            const pastIssues = issue.ê´€ë ¨ê³¼ê±°ì´ìŠˆ || [];
            const iVerified = industries.filter(i => i.verification?.is_grounded).length;
            const pVerified = pastIssues.filter(p => p.verification?.is_grounded).length;
            const totalVerified = iVerified + pVerified;
            const totalItems = Math.min(industries.length, 3) + Math.min(pastIssues.length, 3);
            const rag = issue.RAGë¶„ì„ì‹ ë¢°ë„ || {};
            const consistency = rag.consistency_score || 0;
            const peak = rag.peak_relevance_score || 0;
            const trustInfo = getTrustLevelInfo(totalVerified, totalItems, consistency, peak);

            summaryDiv.innerHTML = `
                <div style="line-height:1.6;"><h4 style="margin-bottom:1rem;color:#333;"> RAG ë¶„ì„ ìš”ì•½</h4>
                <div style="background:#f8f9fa;padding:1rem;border-radius:6px;margin-bottom:1rem;">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                        <div><strong> ì‹ ë¢°ë„ ì§€í‘œ</strong><br>â€¢ ì¼ê´€ì„±: ${consistency}/10<br>â€¢ ìµœê³ ì—°ê´€ë„: ${peak}/10</div>
                        <div><strong> íŒ©íŠ¸ì²´í‚¹</strong><br>â€¢ ê²€ì¦ í†µê³¼: ${totalVerified}/${totalItems||'N/A'} ê°œ<br>â€¢ ì„±ê³µë¥ : ${totalItems>0?Math.round(totalVerified/totalItems*100):0}%</div>
                    </div>
                </div>
                <div style="margin-bottom:1rem;"><strong> ì‚°ì—… ë¶„ì„:</strong> ${industries.length}ê°œ ë°œê²¬, ${iVerified}ê°œ íŒ©íŠ¸ì²´í‚¹ í†µê³¼</div>
                <div style="margin-bottom:1rem;"><strong> ê³¼ê±° ì´ìŠˆ:</strong> ${pastIssues.length}ê°œ ë°œê²¬, ${pVerified}ê°œ íŒ©íŠ¸ì²´í‚¹ í†µê³¼</div>
                <div style="background:${trustInfo.color.bg};padding:0.8rem;border-radius:6px;border-left:4px solid ${trustInfo.color.border};">
                    <strong> ì¢…í•© íŒë‹¨:</strong> ${trustInfo.message}
                </div></div>`;
        }

        function getTrustLevelInfo(verified, total, consistency, peak) {
            const verificationRate = total > 0 ? verified / total : 0;
            const avgScore = (consistency + peak) / 2;
            if (verificationRate >= 0.8 && avgScore >= 7) return { message: "ë§¤ìš° ë†’ì€ ì‹ ë¢°ë„ì˜ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.", color: { bg: '#e8f5e8', border: '#28a745' } };
            if (verificationRate >= 0.5 && avgScore >= 5) return { message: "ì–‘í˜¸í•œ ìˆ˜ì¤€ì˜ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤. ì¶”ê°€ ì •ë³´ì™€ í•¨ê»˜ ì°¸ê³ í•˜ì„¸ìš”.", color: { bg: '#fff3cd', border: '#ffc107' } };
            return { message: "ë‚®ì€ ì‹ ë¢°ë„ì˜ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤. ì°¸ê³ ìš©ìœ¼ë¡œë§Œ í™œìš©í•˜ì„¸ìš”.", color: { bg: '#f8d7da', border: '#dc3545' } };
        }

        function getDefaultReason(category, score) {
            if (score === 'N/A' || isNaN(score)) return 'ë¶„ì„ ê·¼ê±°ê°€ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
            const s = parseFloat(score);
            const r = { 'ì§ì ‘ì _ê¸°ì—…ì˜í–¥': { h: 'ì‹¤ì /ì£¼ê°€ì— ì§ì ‘ì  ì˜í–¥ ë¶„ì„', m: 'ì¼ë¶€ ê¸°ì—…ì— ê°„ì ‘ì  ì˜í–¥ ì˜ˆìƒ', l: 'ì§ì ‘ì  ì˜í–¥ ë¯¸ë¯¸' }, 'ì •ì±…ì _ì˜í–¥': { h: 'ì •ë¶€ ì •ì±…/ê·œì œ ë³€í™”ê°€ ì‹œì¥ì— í° ì˜í–¥ ì „ë§', m: 'ì •ì±…ì  ìš”ì†Œ ìˆìœ¼ë‚˜ ì˜í–¥ ë²”ìœ„ ì œí•œì ', l: 'ì •ì±…ê³¼ ê´€ë ¨ì„± ë‚®ìŒ' }, 'ì‹œì¥_ì‹¬ë¦¬_ì˜í–¥': { h: 'íˆ¬ìì ì‹¬ë¦¬ì— ìƒë‹¹í•œ ì˜í–¥ ì˜ˆìƒ', m: 'ì¼ë¶€ íˆ¬ìì ê´€ì‹¬ ìœ ë°œ ìˆ˜ì¤€', l: 'ì‹¬ë¦¬ ì˜í–¥ ì œí•œì ' }, 'ê±°ì‹œê²½ì œ_ì˜í–¥': { h: 'ê±°ì‹œê²½ì œ ì§€í‘œì— ì˜í–¥ ê°€ëŠ¥ì„±', m: 'ê±°ì‹œê²½ì œì— ì¼ë¶€ ì˜í–¥', l: 'ê±°ì‹œê²½ì œ ì˜í–¥ ë¯¸ë¯¸' }, 'ì‚°ì—…_íŠ¸ë Œë“œ_ì˜í–¥': { h: 'ì‚°ì—… íŠ¸ë Œë“œë¥¼ í¬ê²Œ ë³€í™”ì‹œí‚¬ ì´ìŠˆ', m: 'íŠ¹ì • ì‚°ì—… íŠ¸ë Œë“œì— ì¼ë¶€ ì˜í–¥', l: 'ì‚°ì—… íŠ¸ë Œë“œ ì˜í–¥ ì œí•œì ' } };
            const catR = r[category] || r['ì§ì ‘ì _ê¸°ì—…ì˜í–¥'];
            if (s >= 7) return catR.h; if (s >= 4) return catR.m; return catR.l;
        }

        function toggleScoreBreakdown() {
            const section = document.getElementById('score-breakdown-section');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        function closeAIAnalysisModal() { document.getElementById('ai-analysis-modal').classList.remove('show'); }
        function setupRefreshButton() { document.getElementById('refresh-issues-btn')?.addEventListener('click', loadCurrentIssues); }
        function navigateTo(page) {
            const pages = {
                home: '/static/index.html',        // ë˜ëŠ” '/'
                news: '/static/news.html',
                sector: '/static/sector.html',
                company: '/static/company.html',
                game: '/static/game.html',
                mypage: '/static/mypage.html'   // ë§ˆì´í˜ì´ì§€ ì¶”ê°€
            };
            
            if (pages[page]) {
                window.location.href = pages[page];
            }
        }
        function showNotification(message, type = 'info') { const colors = { success: '#4CAF50', warning: '#ff9800', error: '#f44336', info: '#2196F3' }; const notification = document.createElement('div'); notification.style.cssText = `position:fixed;top:20px;right:20px;background:${colors[type]||colors.info};color:white;padding:15px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:10000;font-weight:500;`; notification.innerHTML = `<div><span>${message}</span><button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:white;font-size:18px;cursor:pointer;margin-left:15px;">Ã—</button></div>`; document.body.appendChild(notification); setTimeout(() => { if (notification.parentElement) notification.remove(); }, 5000); }
        
        // ===================================================================
        //  ì‹œë®¬ë ˆì´ì…˜ ê¸°ëŠ¥ ê´€ë ¨ JavaScript ì½”ë“œ (ê°œì„ ëœ ë²„ì „)
        // ===================================================================

        async function loadSimulationModal() {
            if (document.getElementById('simulation-modal-overlay')) return;
            try {
                const response = await fetch('/static/simulation_modal.html');
                if (!response.ok) throw new Error('simulation_modal.htmlì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                const html = await response.text();
                document.body.insertAdjacentHTML('beforeend', html);
                
                document.getElementById('sim-close-btn').addEventListener('click', () => {
                    document.getElementById('simulation-modal-overlay').classList.remove('show');
                });
            } catch (e) {
                console.error("ì‹œë®¬ë ˆì´ì…˜ ëª¨ë‹¬ ë¡œë“œ ì‹¤íŒ¨:", e);
                showNotification('ì‹œë®¬ë ˆì´ì…˜ UI ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        async function startSimulation(issueName, issueDescription, issueDate) {
            await loadSimulationModal();

            const modal = document.getElementById('simulation-modal-overlay');
            const contentArea = document.getElementById('simulation-content-area');
            
            contentArea.innerHTML = document.getElementById('simulation-step-1-template').innerHTML;
            modal.classList.add('show');
            document.getElementById('sim-issue-name').textContent = issueName;
            document.getElementById('sim-issue-date').textContent = issueDate;

            try {
                const response = await fetch('/api/simulation/analyze_industries', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ issue_name: issueName, issue_description: issueDescription })
                });
                if (!response.ok) throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.statusText}`);
                const result = await response.json();
                if (!result.success) throw new Error(result.detail || 'AI ì‚°ì—… ë¶„ì„ ì‹¤íŒ¨');
                
                const industryCards = document.getElementById('sim-industry-cards');
                industryCards.innerHTML = result.data.industries.map(ind => `
                    <div class="sim-industry-card" onclick="handleIndustrySelection(this, '${issueName.replace(/'/g, "\\'")}', '${issueDate}', '${ind.industry_name.replace(/'/g, "\\'")}')">
                        <h4>${ind.industry_name}</h4>
                        <p>${ind.reason}</p>
                    </div>
                `).join('');

                document.getElementById('sim-loading').style.display = 'none';
                document.getElementById('sim-industry-selection').style.display = 'block';

            } catch (error) {
                document.getElementById('sim-loading').innerHTML = `<p style="color:red;">ë¶„ì„ ì‹¤íŒ¨: ${error.message}</p>`;
            }
        }
        
        async function handleIndustrySelection(cardElement, issueName, issueDate, industryName) {
            const contentArea = document.getElementById('simulation-content-area');
            contentArea.innerHTML = document.getElementById('simulation-step-2-template').innerHTML;
            document.getElementById('sim-selected-industry-name').textContent = industryName;
            document.getElementById('sim-back-to-step1').onclick = () => startSimulation(issueName, '', issueDate);

            try {
                const response = await fetch('/api/simulation/analyze_stocks', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ issue_name: issueName, issue_date: issueDate, industry_name: industryName })
                });
                if (!response.ok) throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.statusText}`);
                const result = await response.json();
                if (!result.success) throw new Error(result.detail || 'AI ì¢…ëª© ë¶„ì„ ì‹¤íŒ¨');

                const data = result.data;
                document.getElementById('sim-ai-stock-analysis-content').innerHTML = data.ai_analysis.related_stocks.map(stock => `<div class="sim-stock-item"><strong>${stock.name} (${stock.ticker})</strong>: ${stock.reason}</div>`).join('');
                document.getElementById('sim-investment-options').innerHTML = Object.keys(data.tickers).map(ticker => `
                    <div class="sim-prediction-box">
                        <h4>${data.tickers[ticker]} (${ticker})</h4>
                        <div class="sim-prediction-options">
                            <label class="up"><input type="radio" name="prediction_${ticker}" value="up" required onchange="toggleInvestmentInput(this)"><span> ìƒìŠ¹</span></label>
                            <label class="down"><input type="radio" name="prediction_${ticker}" value="down" onchange="toggleInvestmentInput(this)"><span> í•˜ë½</span></label>
                        </div>
                        <div class="sim-investment-section" id="investment_${ticker}">
                            <label> íˆ¬ì ê¸ˆì•¡ (ì›):</label>
                            <input type="number" name="investment_${ticker}" value="1000000" min="0" step="100000">
                        </div>
                    </div>`).join('');
                document.getElementById('sim-chart-image').src = `data:image/png;base64,${data.chart_image}`;
                document.getElementById('sim-loading-stocks').style.display = 'none';
                document.getElementById('sim-stock-selection').style.display = 'block';
                document.getElementById('simulation-form').onsubmit = (e) => { e.preventDefault(); handleSimulationSubmit(e.target, issueName, issueDate, data.tickers); };

            } catch (error) {
                document.getElementById('sim-loading-stocks').innerHTML = `<p style="color:red;">ì¢…ëª© ë¶„ì„ ì‹¤íŒ¨: ${error.message}</p>`;
            }
        }

        function toggleInvestmentInput(radio) {
            const ticker = radio.name.split('_')[1];
            const investmentSection = document.getElementById(`investment_${ticker}`);
            const amountInput = investmentSection.querySelector('input[type="number"]');
            if (radio.value === 'up') {
                investmentSection.classList.add('show');
                amountInput.value = '1000000';
            } else {
                investmentSection.classList.remove('show');
                amountInput.value = '0';
            }
        }

        async function handleSimulationSubmit(form, issueName, issueDate, tickers) {
            const contentArea = document.getElementById('simulation-content-area');
            contentArea.innerHTML = `<div style="text-align:center;padding:3rem;"><div class="spinner"></div><p>ê²°ê³¼ ê³„ì‚° ì¤‘...</p></div>`;

            const payload = { issue_name: issueName, issue_date: issueDate, tickers, predictions: {}, investments: {} };
            const formData = new FormData(form);
            for (const ticker of Object.keys(tickers)) {
                payload.predictions[ticker] = formData.get(`prediction_${ticker}`);
                payload.investments[ticker] = parseFloat(formData.get(`investment_${ticker}`) || 0);
            }

            try {
                const response = await fetch('/api/simulation/calculate_result', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error('ê²°ê³¼ ê³„ì‚° ì‹¤íŒ¨');
                const result = await response.json();
                if (!result.success) throw new Error(result.detail || 'ê²°ê³¼ ê³„ì‚° ì‹¤íŒ¨');

                const data = result.data;
                contentArea.innerHTML = document.getElementById('simulation-step-3-template').innerHTML;
                document.getElementById('sim-result-issue-name').textContent = data.issue_name;
                document.getElementById('sim-result-chart-image').src = `data:image/png;base64,${data.chart_image}`;
                
                const grid = document.getElementById('sim-results-grid');
                grid.innerHTML = Object.keys(data.tickers).map(ticker => {
                    const res = data.investment_results[ticker];
                    const pred = data.predictions[ticker];
                    const isCorrect = pred === res.status;
                    return `<div class="sim-result-card"><h4>${data.tickers[ticker]}</h4><p>ë‚˜ì˜ ì˜ˆì¸¡: <span class="${isCorrect ? 'correct' : 'incorrect'}">${pred === 'up' ? 'ìƒìŠ¹' : 'í•˜ë½'}</span></p><p>ì‹¤ì œ ê²°ê³¼: <span class="${res.status}">${res.status === 'up' ? 'ìƒìŠ¹' : 'í•˜ë½'}</span></p><p>ìˆ˜ìµë¥ : <span class="${res.profit_loss >= 0 ? 'profit' : 'loss'}">${res.return_rate.toFixed(2)}%</span></p><p>ì†ìµ: <span class="${res.profit_loss >= 0 ? 'profit' : 'loss'}">${Math.round(res.profit_loss).toLocaleString()} ì›</span></p></div>`;
                }).join('');

                document.getElementById('sim-total-investment').textContent = Math.round(data.total_investment).toLocaleString();
                document.getElementById('sim-total-final-value').textContent = Math.round(data.total_final_value).toLocaleString();
                document.getElementById('sim-total-profit-loss').innerHTML = `<span class="${data.total_profit_loss >= 0 ? 'profit' : 'loss'}">${Math.round(data.total_profit_loss).toLocaleString()}</span>`;
                document.getElementById('sim-prediction-accuracy').textContent = data.prediction_accuracy.toFixed(1);
                
                document.getElementById('sim-ai-commentary-content').innerHTML = data.ai_commentary.replace(/\n/g, '<br>');

                //  [ìˆ˜ì •] ê²°ê³¼ í™”ë©´ì´ ê·¸ë ¤ì§„ í›„, ë²„íŠ¼ì„ ì°¾ì•„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì—°ê²°í•©ë‹ˆë‹¤.
                const restartBtn = document.getElementById('sim-restart-btn');
                if(restartBtn) {
                    restartBtn.onclick = () => document.getElementById('simulation-modal-overlay').classList.remove('show');
                }

            } catch (error) {
                contentArea.innerHTML = `<p style="color:red;">ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
            }
        }

        /**
         * [ëŒ€ì²´] ê³¼ê±° ì´ìŠˆ ëª©ë¡ì„ í‘œì‹œí•  ë•Œ, startSimulation í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë„ë¡ onclick ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.
         */
        function displayPastIssuesWithSimulation(issue) {
            const pastIssuesDiv = document.getElementById('modal-related-past-issues');
            const relatedPastIssues = (issue.ê´€ë ¨ê³¼ê±°ì´ìŠˆ || []).slice(0, 3);
            
            if (Array.isArray(relatedPastIssues) && relatedPastIssues.length > 0) {
                pastIssuesDiv.innerHTML = relatedPastIssues.map((pastIssue, idx) => {
                    const issueName = pastIssue.name || 'ì´ë¦„ ì—†ìŒ';
                    const issueDesc = pastIssue.description || '';
                    const period = pastIssue.period || '';
                    let issueDate = 'N/A';
                    const dateMatch = period.match(/\d{4}-\d{2}-\d{2}/);
                    if (dateMatch) issueDate = dateMatch[0];

                    const escapedName = issueName.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const escapedDesc = issueDesc.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const verification = pastIssue.verification || {};
                    const isVerified = verification.is_grounded === true;
                    const verificationColor = isVerified ? '#28a745' : '#ffc107';
                    const verificationIcon = isVerified ? '' : 'âš ï¸';
                    const verificationText = isVerified ? 'íŒ©íŠ¸ì²´í‚¹ í†µê³¼' : 'ê·¼ê±° ë¶€ì¡±';
                    const supportingQuote = verification.supporting_quote || '';
                    const unverifiedReason = verification.unverified_reason || '';

                    return `
                        <div class="modal-item" style="border-left: 4px solid ${verificationColor};">
                            <div class="modal-item-title">
                                <span>${idx + 1}. ${pastIssue.name}</span>
                                <span class="modal-item-score">(ì ìˆ˜: ${pastIssue.final_score || 'N/A'}/10)</span>
                            </div>
                             <div class="verification-result" style="background: ${isVerified ? '#f8fff9' : '#fff8f0'}; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.3rem;">
                                    <span>${verificationIcon}</span><strong style="color: ${verificationColor};">${verificationText}</strong>
                                </div>
                                ${supportingQuote ? `<div style="font-style: italic; color: #666; font-size: 0.9rem;">"ë‰´ìŠ¤ ê·¼ê±°: ${supportingQuote}"</div>` : ''}
                                ${!isVerified && unverifiedReason ? `<div style="font-style: italic; color: #856404; font-size: 0.9rem;">(ì‚¬ìœ : ${unverifiedReason})</div>` : ''}
                            </div>
                            <div class="modal-item-reason"><strong>ìœ ì‚¬ì„± ê·¼ê±°:</strong> ${pastIssue.ai_reason || 'ë¶„ì„ ì •ë³´ ì—†ìŒ'}</div>
                            <div class="modal-item-meta" style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #eee; padding-top: 0.5rem; margin-top: 0.5rem;">
                                <div><div>ë°œìƒ ê¸°ê°„: ${period}</div></div>
                                <button 
                                    onclick="startSimulation('${escapedName}', '${escapedDesc}', '${issueDate}')" 
                                    class="simulation-btn"
                                    ${issueDate === 'N/A' ? 'disabled title="ì •í™•í•œ ë‚ ì§œ ì •ë³´ê°€ ì—†ì–´ ì‹œë®¬ë ˆì´ì…˜ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."' : ''}>
                                     ì‹œë®¬ë ˆì´ì…˜
                                </button>
                            </div>
                        </div>`;
                }).join('');
            } else {
                pastIssuesDiv.innerHTML = '<div style="color:#666; text-align:center; padding:2rem;">ê´€ë ¨ ê³¼ê±° ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
        }
    </script>
</body>
</html>