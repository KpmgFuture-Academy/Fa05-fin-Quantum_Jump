<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ë¥´ë‹¤ - ê³¼ê±° ë‰´ìŠ¤ ë¶„ì„</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; color: #333; }
        .layout { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: white; border-right: 1px solid #e9ecef; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        .logo-section { background: linear-gradient(135deg, #FF6B6B 0%, #FF5252 100%); color: white; padding: 1.5rem; text-align: center; }
        .logo { font-size: 1.8rem; font-weight: bold; margin-bottom: 0.5rem; }
        .logo-subtitle { font-size: 0.9rem; opacity: 0.9; }
        .nav-menu { padding: 1.5rem 0; }
        .nav-item { padding: 1rem 1.5rem; cursor: pointer; transition: all 0.3s ease; border-left: 4px solid transparent; display: flex; align-items: center; gap: 0.8rem; }
        .nav-item:hover { background-color: #f8f9fa; border-left-color: #FF6B6B; }
        .nav-item.active { background-color: #fff3f3; border-left-color: #FF6B6B; color: #FF6B6B; font-weight: 600; }
        .nav-icon { font-size: 1.1rem; width: 20px; }
        .main-content { flex: 1; padding: 2rem; overflow-y: auto; }
        .page-header { background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .breadcrumb { color: #6c757d; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .page-title { font-size: 2rem; font-weight: 700; color: #2c3e50; margin-bottom: 0.5rem; }
        .page-subtitle { color: #6c757d; font-size: 1.1rem; line-height: 1.6; }
        .search-filter-section { background: white; border-radius: 12px; padding: 1.5rem 2rem; margin-bottom: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .search-controls { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
        .search-box { flex: 1; min-width: 300px; position: relative; }
        .search-input { width: 100%; padding: 0.8rem 1rem 0.8rem 2.5rem; border: 2px solid #e9ecef; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s ease; }
        .search-input:focus { outline: none; border-color: #FF6B6B; }
        .search-icon { position: absolute; left: 0.8rem; top: 50%; transform: translateY(-50%); color: #6c757d; }
        .filter-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .filter-btn { padding: 0.6rem 1.2rem; border: 2px solid #e9ecef; background: white; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem; }
        .filter-btn:hover { border-color: #FF6B6B; }
        .filter-btn.active { background: #FF6B6B; color: white; border-color: #FF6B6B; }
        .news-section { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .section-title { font-size: 1.4rem; font-weight: 600; color: #2c3e50; }
        .news-list { display: flex; flex-direction: column; gap: 1rem; }
        .news-item { border: 1px solid #e9ecef; border-radius: 8px; padding: 1.5rem; transition: all 0.3s ease; display: flex; justify-content: space-between; align-items: flex-start; gap: 1.5rem; }
        .news-item:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); border-color: #FF6B6B; }
        .news-content { flex: 1; cursor: pointer; }
        .news-meta { display: flex; gap: 1rem; align-items: center; margin-bottom: 0.8rem; font-size: 0.9rem; color: #6c757d; flex-wrap: wrap; }
        .news-date { background: #f8f9fa; padding: 0.3rem 0.8rem; border-radius: 15px; }
        /* â–¼â–¼â–¼ ì¹´í…Œê³ ë¦¬(ì‚°ì—…) ìŠ¤íƒ€ì¼ ì¶”ê°€ â–¼â–¼â–¼ */
        .news-industry { background: #e3f2fd; color: #1976d2; padding: 0.3rem 0.8rem; border-radius: 15px; font-weight: 500; }
        .news-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 0.8rem; line-height: 1.4; color: #2c3e50; }
        .news-summary { color: #6c757d; line-height: 1.6; }
        .news-actions { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
        .bookmark-star { font-size: 1.8rem; color: #ced4da; cursor: pointer; transition: all 0.2s ease-in-out; }
        .bookmark-star:hover { transform: scale(1.2); }
        .bookmark-star.bookmarked { color: #FFC107; }
        .btn-analyze { background: #FF6B6B; color: white; padding: 0.6rem 1.2rem; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-analyze:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: white; max-width: 800px; max-height: 90vh; overflow-y: auto; padding: 2rem; border-radius: 12px; margin: 1rem; position: relative; }
        .modal-close-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 24px; cursor: pointer; color: #666; }
        .modal-title { margin: 0 2rem 1.5rem 0; color: #333; font-size: 1.5rem; }
        .modal-section { margin-bottom: 1.5rem; }
        .modal-section-title { margin-bottom: 0.8rem; color: #333; font-size: 1.1rem; border-bottom: 2px solid #f0f0f0; padding-bottom: 0.5rem; }
        .modal-text-box { background: #f8f9fa; padding: 1rem; border-radius: 8px; line-height: 1.6; max-height: 200px; overflow-y: auto; }
        .modal-highlight-box { background: #e8f5e8; padding: 1rem; border-radius: 8px; line-height: 1.6; }
        .modal-footer { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #eee; font-size: 0.9rem; color: #666; }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin-top: 2rem; }
        .page-btn { padding: 0.6rem 1rem; border: 1px solid #e9ecef; background: white; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; }
        .page-btn:hover { border-color: #FF6B6B; }
        .page-btn.active { background: #FF6B6B; color: white; border-color: #FF6B6B; }
        .loading { text-align: center; padding: 3rem; color: #6c757d; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #FF6B6B; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="layout">
        <div class="sidebar">
            <div class="logo-section">
                <div class="logo">ì˜¤ë¥´ë‹¤</div>
                <div class="logo-subtitle">íˆ¬ì í•™ìŠµ í”Œë«í¼</div>
            </div>
            <div class="nav-menu">
                <div class="nav-item" onclick="navigateTo('home')"><span class="nav-icon"></span><span>Home</span></div>
                <div class="nav-item" onclick="navigateTo('mypage')"><span class="nav-icon"></span><span>My Page</span></div>
                <div class="nav-item active" onclick="navigateTo('news')"><span class="nav-icon"></span><span>News</span></div>
                <div class="nav-item" onclick="navigateTo('sector')"><span class="nav-icon"></span><span>Sector</span></div>
                <div class="nav-item" onclick="navigateTo('company')"><span class="nav-icon"></span><span>Company</span></div>
                <div class="nav-item" onclick="navigateTo('game')"><span class="nav-icon"></span><span>Game</span></div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="page-header" style="text-align: center;">
                <h1 class="page-title"> ê³¼ê±° ë‰´ìŠ¤ ë¶„ì„</h1>
                <p class="page-subtitle">ê³¼ê±°ì˜ ì£¼ìš” ê²½ì œ/ì‚°ì—… ì´ìŠˆë“¤ì„ í™•ì¸í•˜ê³  íˆ¬ì ì¸ì‚¬ì´íŠ¸ë¥¼ ì–»ì–´ë³´ì„¸ìš”.</p>
            </div>
            
            <div class="search-filter-section">
                <div class="search-controls">
                    <div class="search-box">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" class="search-input" id="search-input" placeholder="ë‰´ìŠ¤ ì œëª©, ë‚´ìš©, í‚¤ì›Œë“œ ê²€ìƒ‰...">
                    </div>
                </div>
            </div>
            
            <div class="news-section">
                <div class="section-header">
                    <h2 class="section-title">ë‰´ìŠ¤ ëª©ë¡ (<span id="news-count">0</span>ê°œ)</h2>
                </div>
                <div class="news-list" id="news-container"></div>
                <div class="pagination" id="pagination"></div>
            </div>
        </div>
    </div>
    
    <div id="news-analysis-modal" class="modal-overlay">
        <div class="modal-content">
            <button onclick="closeNewsAnalysisModal()" class="modal-close-btn">&times;</button>
            <h2 id="modal-news-title" class="modal-title"></h2>
            <div class="modal-section">
                <h3 class="modal-section-title"> ì›ë³¸ ë‰´ìŠ¤ ë‚´ìš©</h3>
                <div id="modal-news-content" class="modal-text-box"></div>
            </div>
            <div class="modal-section">
                <h3 class="modal-section-title"> AI ë¶„ì„ ê´€ë ¨ ì‚°ì—…</h3>
                <div id="modal-related-industries" class="modal-highlight-box"></div>
            </div>
            <div class="modal-section">
                <h3 class="modal-section-title"> AI ë¶„ì„ ì‚°ì—… ì˜í–¥</h3>
                <div id="modal-industry-analysis" class="modal-highlight-box" style="background: #fff8e1;"></div>
            </div>
             <div class="modal-section">
                <h3 class="modal-section-title"> ê·¼ê±° ìë£Œ</h3>
                <div id="modal-evidence" class="modal-text-box"></div>
            </div>
            <div class="modal-footer">
                <span id="modal-analysis-timestamp"></span>
            </div>
        </div>
    </div>
    
    <script>
        let allNewsData = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        document.addEventListener('DOMContentLoaded', function() {
            loadPastNewsFromDatabase();
            setupEventListeners();
        });

        async function loadPastNewsFromDatabase(searchTerm = '') {
            showLoadingState();
            try {
                const url = searchTerm ? `/api/news/past?search=${encodeURIComponent(searchTerm)}&limit=200` : '/api/news/past?limit=200';
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const result = await response.json();
                if (result.success && Array.isArray(result.data)) {
                    allNewsData = result.data;
                    currentPage = 1;
                    renderPage(currentPage);
                    showNotification(`ì´ ${allNewsData.length}ê°œì˜ ê³¼ê±° ì´ìŠˆë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`, 'success');
                } else {
                    throw new Error('API ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ê³¼ê±° ë‰´ìŠ¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showErrorState('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                showNotification('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function renderPage(page) {
            currentPage = page;
            const container = document.getElementById('news-container');
            const paginatedData = allNewsData.slice((page - 1) * itemsPerPage, page * itemsPerPage);
            container.innerHTML = '';
            if (paginatedData.length === 0) {
                showEmptyState();
            } else {
                 const bookmarkedIssues = JSON.parse(localStorage.getItem('bookmarkedIssues')) || [];
                paginatedData.forEach(item => {
                    const isBookmarked = bookmarkedIssues.some(b => b.id === item.id);
                    container.appendChild(createNewsListItem(item, isBookmarked));
                });
            }
            updateNewsCount(allNewsData.length);
            updatePagination();
        }

        function createNewsListItem(news, isBookmarked) {
            const item = document.createElement('div');
            item.className = 'news-item';
            const title = news.title || 'ì œëª© ì—†ìŒ';
            const summary = news.summary || 'ìš”ì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.';
            const category = news.related_industries || 'ì¹´í…Œê³ ë¦¬ ì—†ìŒ';
            const dateInfo = formatDatePeriod(news.start_date, news.end_date);
            item.innerHTML = `
                <div class="news-content" onclick="showNewsAnalysisModal('${news.id}')">
                    <div class="news-meta">
                        <div class="news-date">${dateInfo}</div>
                        <div class="news-industry">${category}</div>
                    </div>
                    <h3 class="news-title">${title}</h3>
                    <p class="news-summary">${summary}</p>
                </div>
                <div class="news-actions">
                    <div class="bookmark-star ${isBookmarked ? 'bookmarked' : ''}" onclick="bookmarkNews(this, '${news.id}')">
                        ${isBookmarked ? 'â˜…' : 'â˜†'}
                    </div>
                    <button class="action-btn btn-analyze" onclick="showNewsAnalysisModal('${news.id}')">ìƒì„¸ ë¶„ì„</button>
                </div>
            `;
            return item;
        }

        // --- â–¼â–¼â–¼ í•µì‹¬ ìˆ˜ì • ë¶€ë¶„: ìƒì„¸ ë¶„ì„ ëª¨ë‹¬ ê¸°ëŠ¥ â–¼â–¼â–¼ ---
        async function showNewsAnalysisModal(newsId) {
            const news = allNewsData.find(n => String(n.id) === String(newsId));
            if (!news) return;

            const modal = document.getElementById('news-analysis-modal');
            const industriesDiv = document.getElementById('modal-related-industries');
            const analysisDiv = document.getElementById('modal-industry-analysis');

            // 1. ê¸°ë³¸ ì •ë³´ ë¨¼ì € í‘œì‹œ
            document.getElementById('modal-news-title').textContent = news.title || 'ì œëª© ì—†ìŒ';
            document.getElementById('modal-news-content').innerHTML = (news.content || 'ë‚´ìš© ì—†ìŒ').replace(/\n/g, '<br>');
            document.getElementById('modal-evidence').textContent = news.evidence_source || 'ê·¼ê±° ìë£Œ ì •ë³´ ì—†ìŒ';
            document.getElementById('modal-analysis-timestamp').textContent = `ì´ìŠˆ ê¸°ê°„: ${formatDatePeriod(news.start_date, news.end_date)}`;
            
            // 2. ëª¨ë‹¬ì„ ë„ìš°ê³  AI ë¶„ì„ ì„¹ì…˜ì— ë¡œë”© ìƒíƒœ í‘œì‹œ
            industriesDiv.innerHTML = `<div class="loading"><div class="spinner"></div><p>AIê°€ ê´€ë ¨ ì‚°ì—…ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p></div>`;
            analysisDiv.innerHTML = `<div class="loading"><div class="spinner"></div><p>AIê°€ ì‚°ì—… ì˜í–¥ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p></div>`;
            modal.style.display = 'flex';

            // 3. simulation_apiì— AI ë¶„ì„ ìš”ì²­
            try {
                const response = await fetch('/api/simulation/analyze_industries', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        issue_name: news.title,
                        issue_description: news.content || news.summary 
                    })
                });

                if (!response.ok) throw new Error(`ì„œë²„ ë¶„ì„ ì˜¤ë¥˜: ${response.status}`);
                const result = await response.json();
                if (!result.success || !result.data || !result.data.industries) {
                    throw new Error('AI ë¶„ì„ ê²°ê³¼ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
                
                // 4. ì„±ê³µ ì‹œ, ë¶„ì„ ê²°ê³¼ë¡œ ëª¨ë‹¬ ë‚´ìš© ì—…ë°ì´íŠ¸
                const industries = result.data.industries;
                
                industriesDiv.innerHTML = industries.map(ind => 
                    `<p><strong>- ${ind.industry_name || 'N/A'}</strong></p>`
                ).join('');

                analysisDiv.innerHTML = industries.map(ind => 
                    `<p><strong>[${ind.industry_name || 'N/A'}]</strong> ${ind.reason || 'ë¶„ì„ ë‚´ìš© ì—†ìŒ'}</p>`
                ).join('<hr style="border:0; border-top:1px solid #eee; margin: 0.5rem 0;">');

            } catch (error) {
                console.error("AI ì‚°ì—… ë¶„ì„ ì‹¤íŒ¨:", error);
                industriesDiv.innerHTML = `<p style="color:red;">ê´€ë ¨ ì‚°ì—… ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
                analysisDiv.innerHTML = `<p style="color:red;">ì‚°ì—… ì˜í–¥ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
            }
        }

        function closeNewsAnalysisModal() {
            document.getElementById('news-analysis-modal').style.display = 'none';
        }

        function setupEventListeners() {
            const searchInput = document.getElementById('search-input');
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => { loadPastNewsFromDatabase(e.target.value); }, 500);
            });
             document.getElementById('news-analysis-modal').addEventListener('click', function(e) {
                if (e.target === this) closeNewsAnalysisModal();
            });
        }
        function updateNewsCount(count) { document.getElementById('news-count').textContent = count; }
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            const totalPages = Math.ceil(allNewsData.length / itemsPerPage);
            if (totalPages <= 1) return;
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);
            pagination.insertAdjacentHTML('beforeend', `<button class="page-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>â€¹</button>`);
            for (let i = startPage; i <= endPage; i++) {
                pagination.insertAdjacentHTML('beforeend', `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`);
            }
            pagination.insertAdjacentHTML('beforeend', `<button class="page-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>â€º</button>`);
        }
        function changePage(page) {
            const totalPages = Math.ceil(allNewsData.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            renderPage(page);
        }
        function bookmarkNews(element, newsId) {
            event.stopPropagation();
            const newsToBookmark = allNewsData.find(n => String(n.id) === String(newsId));
            if (!newsToBookmark) return;
            let bookmarkedIssues = JSON.parse(localStorage.getItem('bookmarkedIssues')) || [];
            const existingIndex = bookmarkedIssues.findIndex(b => b.id === newsToBookmark.id);
            if (existingIndex > -1) {
                bookmarkedIssues.splice(existingIndex, 1);
                element.innerHTML = 'â˜†';
                element.classList.remove('bookmarked');
                showNotification(`'${newsToBookmark.title}' ë¶ë§ˆí¬ë¥¼ í•´ì œí–ˆìŠµë‹ˆë‹¤.`, 'info');
            } else {
                bookmarkedIssues.push(newsToBookmark);
                element.innerHTML = 'â˜…';
                element.classList.add('bookmarked');
                showNotification(`'${newsToBookmark.title}' ì´ìŠˆë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤!`, 'success');
            }
            localStorage.setItem('bookmarkedIssues', JSON.stringify(bookmarkedIssues));
        }
        function formatDatePeriod(startDate, endDate) {
            const format = (dateStr) => {
                if (!dateStr || dateStr === 'í˜„ì¬') return dateStr;
                try {
                    const date = new Date(dateStr);
                    return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;
                } catch { return dateStr; }
            };
            const start = format(startDate);
            const end = format(endDate);
            return (end && start !== end) ? `${start} ~ ${end}` : start;
        }
        function showLoadingState() { document.getElementById('news-container').innerHTML = `<div class="loading"><div class="spinner"></div><p>ê³¼ê±° ì´ìŠˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>`; }
        function showEmptyState() { document.getElementById('news-container').innerHTML = `<div class="loading"><p>í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`; }
        function showErrorState(message) { document.getElementById('news-container').innerHTML = `<div class="loading"><p style="color:#dc3545;">${message}</p></div>`; }
        function showNotification(message, type = 'info') { /* ìƒëµ */ }
        function navigateTo(page) {
            const pages = {
                'home': '/static/index.html', 'mypage': '/static/mypage.html',
                'news': '/static/news.html', 'sector': '/static/sector.html',
                'company': '/static/company.html', 'game': '/static/game.html'
            };
            if (pages[page] && window.location.pathname !== pages[page]) {
                window.location.href = pages[page];
            }
        }
    </script>
</body>
</html>